<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è–èª•éº‹é¹¿å†’éšªï¼šè¦å»å“ªè£¡æ“¾äº‚äººé¡ä¸–ç•Œå‘¢</title>
    <meta name="theme-color" content="#7f1d1d">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.jpg">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-red-900 via-green-900 to-blue-900 text-white select-none">

<div id="app" class="max-w-md mx-auto min-h-screen p-4 flex flex-col">
    
    <header class="text-center py-4 mb-4">
        <div class="w-24 h-24 mx-auto mb-2 rounded-full overflow-hidden border-4 border-yellow-400 shadow-lg">
            <img src="icon.jpg" alt="éº‹é¹¿ç¸" class="w-full h-full object-cover">
        </div>
        <h1 class="text-3xl font-bold text-yellow-300 drop-shadow-md">ğŸ¦Œ è–èª•éº‹é¹¿å†’éšª ğŸ„</h1>
    </header>

    <div id="view-setup" class="flex-1 fade-in">
        <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 shadow-xl border border-white/20">
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <span>ğŸ›¡ï¸ è‹±é›„åå–®</span>
                <span id="count-display" class="ml-auto text-sm bg-red-600 px-2 py-1 rounded-full">13äºº</span>
            </h2>
            
            <div id="participants-list" class="space-y-2 max-h-60 overflow-y-auto mb-4 pr-1">
                </div>

            <div class="flex gap-2 mb-6">
                <input type="text" id="new-name" placeholder="è¼¸å…¥æ–°è‹±é›„åå­—" class="flex-1 bg-white/20 border border-white/30 rounded px-3 py-2 text-white placeholder-gray-300 focus:outline-none focus:border-yellow-400">
                <button onclick="addParticipant()" class="bg-green-600 hover:bg-green-500 px-4 py-2 rounded font-bold shadow">ï¼‹</button>
            </div>

            <div class="border-t border-white/20 pt-4 mb-6">
                <h3 class="text-lg font-bold mb-2 text-pink-300">â¤ï¸ ç¦å¿Œä¹‹æˆ€ (å¤«å¦»è¨­å®š)</h3>
                <p class="text-xs text-gray-300 mb-2">é€™å…©ä½è‹±é›„çµ•å°ä¸æœƒæŠ½åˆ°å½¼æ­¤</p>
                <div class="flex gap-2">
                    <input type="text" id="couple-1" value="ç´«ç’‡" class="w-1/2 bg-pink-900/40 border border-pink-500/50 rounded px-3 py-2 text-center">
                    <span class="py-2 text-pink-400">âš¡</span>
                    <input type="text" id="couple-2" value="æ™ºå ¯" class="w-1/2 bg-pink-900/40 border border-pink-500/50 rounded px-3 py-2 text-center">
                </div>
            </div>

            <button onclick="startStory()" class="w-full bg-gradient-to-r from-yellow-500 to-red-600 py-4 rounded-xl text-xl font-bold shadow-lg transform active:scale-95 transition-all">
                âš”ï¸ é–‹å§‹å†’éšª
            </button>
            
            <div class="mt-4 text-center">
                 <button onclick="resetData()" class="text-xs text-gray-400 underline">æ¸…é™¤æ‰€æœ‰ç´€éŒ„é‡ç½®</button>
            </div>
        </div>
    </div>

    <div id="view-story" class="hidden flex-1 flex flex-col justify-center items-center text-center fade-in p-4">
        <div class="bg-black/60 p-6 rounded-xl border border-red-500/50 shadow-2xl">
            <h2 class="text-2xl font-bold text-red-400 mb-4">âš ï¸ è­¦å ±ï¼šç½é›£é™è‡¨</h2>
            <p class="text-lg leading-relaxed mb-6 text-gray-100 text-left">
                è–èª•ç¯€é€™å¤©ç”¦é†’äº†...<br><br>
                é£¢é¤“å·²ä¹…çš„<b>éº‹é¹¿ç¸</b>æº–å‚™é€²åˆ°äººé¡ä¸–ç•Œï¼Œç‰ æ­£å°‹æ‰¾è‘—å¹³éœçš„ç¤¾æœƒå¤§è‚†ç ´å£ã€‚<br><br>
                é€™ <span id="story-count" class="text-yellow-400 font-bold">15</span> ä½è‹±é›„å€‘æ˜¯å¦èƒ½å¤ ç¶­æŒç¤¾æœƒå’Œå¹³å‘¢ï¼Ÿ<br>
                é‚„æ˜¯æœƒè¢«éº‹é¹¿ç¸çµ¦ä¸€å£åä¸‹ï¼Ÿ<br><br>
                å‘½é‹çš„è½‰ç›¤å·²ç¶“é–‹å§‹è½‰å‹•...
            </p>
            <button onclick="enterDraw()" class="bg-red-600 hover:bg-red-500 text-white px-8 py-3 rounded-full font-bold text-lg animate-pulse shadow-lg ring-4 ring-red-900">
                é€²å…¥æˆ°å ´
            </button>
        </div>
    </div>

    <div id="view-drawing" class="hidden flex-1 flex flex-col fade-in">
        <div class="text-center mb-8">
            <div class="inline-block bg-blue-900/80 px-4 py-1 rounded-full text-sm border border-blue-400 mb-2">
                ç¬¬ <span id="round-number">1</span> å›åˆ
            </div>
            <h2 class="text-3xl font-bold mt-2">
                è´ˆç¦®è€…ï¼š<span id="current-giver" class="text-yellow-300 border-b-2 border-yellow-300">è‹±é›„A</span>
            </h2>
        </div>

        <div id="gift-box-area" class="flex-1 flex flex-col items-center justify-center cursor-pointer" onclick="revealReceiver()">
            <div class="text-9xl animate-bounce">ğŸ</div>
            <p class="mt-4 text-xl animate-pulse text-yellow-200">é»æ“Šæ‰“é–‹ç¥ç§˜ç¦®ç‰©...</p>
        </div>

        <div id="reveal-area" class="hidden flex-1 flex flex-col items-center justify-center">
            <p class="text-gray-300 text-sm mb-2">ç¦®ç‰©æ˜¯é€çµ¦...</p>
            <div class="text-5xl font-bold text-green-400 mb-8 drop-shadow-lg" id="current-receiver">
                è‹±é›„B
            </div>
            
            <div class="w-full bg-white/10 backdrop-blur rounded-xl p-6 border border-white/20">
                <p class="text-center mb-4 text-lg">æ¥æ”¶è€…æ»¿æ„é€™ä»½ç¦®ç‰©å—ï¼Ÿ</p>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="handleFeedback(true)" class="bg-green-600 hover:bg-green-500 py-4 rounded-lg font-bold flex flex-col items-center gap-1 transform active:scale-95 transition">
                        <span class="text-2xl">âš”ï¸</span>
                        <span>æ»¿æ„ (é€²æ”»)</span>
                    </button>
                    <button onclick="handleFeedback(false)" class="bg-red-600 hover:bg-red-500 py-4 rounded-lg font-bold flex flex-col items-center gap-1 transform active:scale-95 transition">
                        <span class="text-2xl">ğŸ˜±</span>
                        <span>ä¸æ»¿æ„ (è¢«åƒ)</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="battle-result-area" class="hidden flex-1 flex flex-col items-center justify-center text-center p-4">
            <div id="battle-emoji" class="text-8xl mb-4 shake"></div>
            <p id="battle-text" class="text-xl font-bold leading-relaxed mb-8"></p>
            <button onclick="nextRound()" class="w-full bg-yellow-500 text-black font-bold py-3 rounded-lg shadow-lg">
                ç¹¼çºŒä¸‹ä¸€ä½è‹±é›„
            </button>
        </div>
    </div>

    <div id="view-result" class="hidden flex-1 fade-in">
        <h2 class="text-2xl font-bold text-center mb-6 text-yellow-300">ğŸ“œ æˆ°å½¹ç´€éŒ„</h2>
        
        <div class="bg-white/90 text-gray-900 rounded-xl shadow-2xl overflow-hidden">
            <div class="max-h-[60vh] overflow-y-auto" id="final-list">
                </div>
        </div>

        <div class="mt-6 flex gap-3">
             <button onclick="downloadScreenshot()" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-lg shadow text-center">
                ğŸ“¸ æˆªåœ–ä¿å­˜
            </button>
            <button onclick="resetData()" class="flex-1 bg-gray-600 text-white font-bold py-3 rounded-lg shadow text-center">
                ğŸ”„ é‡æ–°é–‹å§‹
            </button>
        </div>
    </div>

</div>

<script>
    // --- è³‡æ–™èˆ‡ç‹€æ…‹ ---
    const defaultParticipants = [
        'æ™¨è±ª', 'ä½³ç‘œ', 'å¿µæ…ˆ', 'è© ç­‘', 'æƒ å­', 
        'äº­æ½”', 'å£«å®¶', 'å† å®‡', 'æ•æ¯“', 'æŸèŒµ', 
        'è‹±ç­‘', 'ç´«ç’‡', 'æ™ºå ¯'
    ];
    
    let participants = [...defaultParticipants];
    let couple = { p1: 'ç´«ç’‡', p2: 'æ™ºå ¯' };
    let drawOrder = [];
    let currentIndex = 0;
    let battleHistory = [];

    // å‹åˆ©èˆ‡å¤±æ•—è…³æœ¬ (ä¾†è‡ªä¾†æº)
    const victoryScenarios = [
        { emoji: 'âš”ï¸', text: 'æ®èˆè–èª•ä¹‹åŠï¼Œä¸€åŠæ–¬æ–·éº‹é¹¿ç¸çš„é¹¿è§’ï¼Œéº‹é¹¿ç¸è½è’è€Œé€ƒï¼' },
        { emoji: 'ğŸ', text: 'ç”¨ç¦®ç‰©çš„æº«æš–ä¹‹åŠ›èåŒ–äº†éº‹é¹¿ç¸çš„å†°å†·ä¹‹å¿ƒï¼Œç‰ æ„Ÿå‹•å¾—æµä¸‹çœ¼æ·šï¼' },
        { emoji: 'ğŸ”¥', text: 'å¬å–šè–èª•ç«ç„°ï¼Œç…§äº®é»‘æš—ï¼éº‹é¹¿ç¸è¢«å…‰æ˜é©…æ•£ï¼' },
        { emoji: 'â„ï¸', text: 'ä½¿ç”¨å†°é›ªé­”æ³•å°‡éº‹é¹¿ç¸å†°å°ï¼Œç‰ è¢«å‡æˆäº†å†°é›•ï¼' },
        { emoji: 'â­', text: 'å¬å–šæ˜Ÿå…‰ä¹‹åŠ›ï¼Œè¬åƒæµæ˜ŸåŠƒç ´å¤©éš›ï¼Œéº‹é¹¿ç¸è¢«æ˜Ÿå…‰æ·¨åŒ–ï¼' },
        { emoji: 'ğŸµ', text: 'å”±èµ·è–èª•é Œæ­Œï¼Œç¾å¦™çš„æ—‹å¾‹è®“éº‹é¹¿ç¸è·³èµ·èˆä¾†ï¼Œå¿˜è¨˜äº†æˆ°é¬¥ï¼' },
        { emoji: 'ğŸª', text: 'æ‹¿å‡ºç¥–å‚³çš„è–èª•é¤…ä¹¾ï¼Œéº‹é¹¿ç¸èåˆ°é¦™å‘³å¾Œä¹–ä¹–æŠ•é™ï¼' },
        { emoji: 'ğŸ„', text: 'ç¨®ä¸‹è–èª•æ¨¹ï¼Œç¶ è‰²çš„ç”Ÿå‘½åŠ›è®“éº‹é¹¿ç¸å›æ­¸å–„è‰¯æœ¬æ€§ï¼' },
        { emoji: 'ğŸ””', text: 'æ–éŸ¿è–èª•éˆ´éºï¼Œæ¸…è„†çš„éˆ´è²è®“éº‹é¹¿ç¸æšˆé ­è½‰å‘ï¼Œç‹¼ç‹½é€ƒèµ°ï¼' },
        { emoji: 'âœ¨', text: 'æ•£ç™¼è–èª•é­”æ³•ç²‰å¡µï¼Œéº‹é¹¿ç¸åœ¨é–ƒå…‰ä¸­åŒ–ç‚ºç…™éœ§æ¶ˆæ•£ï¼' },
        { emoji: 'ğŸ…', text: 'å¬å–šè–èª•è€äººé™è‡¨ï¼Œéº‹é¹¿ç¸ä¸€çœ‹åˆ°è€é—†ä¾†äº†ç«‹åˆ»è·ªåœ°æ±‚é¥’ï¼' },
        { emoji: 'ğŸ¦Œ', text: 'ç”¨æ„›æ„ŸåŒ–éº‹é¹¿ç¸ï¼Œç‰ æ±ºå®šæ”¹é‚ªæ­¸æ­£ï¼ŒåŠ å…¥è–èª•è€äººçš„é›ªæ©‡éšŠï¼' },
        { emoji: 'ğŸŒŸ', text: 'å¼•å°åŒ—æ¥µæ˜Ÿä¹‹å…‰ï¼Œç¥è–çš„å…‰èŠ’ç…§è€€å¤§åœ°ï¼Œéº‹é¹¿ç¸è·ªåœ°è‡£æœï¼' },
        { emoji: 'ğŸº', text: 'å¹éŸ¿å‹åˆ©è™Ÿè§’ï¼Œéœ‡è€³æ¬²è¾çš„è²éŸ¿åš‡å¾—éº‹é¹¿ç¸æŠ±é ­é¼ ç«„ï¼' },
        { emoji: 'ğŸ·', text: 'è«‹éº‹é¹¿ç¸å–è–èª•ç†±ç´…é…’ï¼Œç‰ å–é†‰å¾Œç¡è‘—äº†ï¼Œå±æ©Ÿè§£é™¤ï¼' }
    ];

    const defeatScenarios = [
        { emoji: 'ğŸ˜±', text: 'é‚„æ²’åæ‡‰éä¾†ï¼Œå°±è¢«éº‹é¹¿ç¸ä¸€å£åä¸‹è‚šäº†ï¼' },
        { emoji: 'ğŸ’¨', text: 'æƒ³è¦é€ƒè·‘ï¼Œä½†éº‹é¹¿ç¸çš„é€Ÿåº¦å¤ªå¿«ï¼Œç¬é–“å°±è¢«è¿½ä¸Šåƒæ‰äº†ï¼' },
        { emoji: 'ğŸŒ€', text: 'è¢«éº‹é¹¿ç¸çš„é»‘æš—æ¼©æ¸¦æ²å…¥ï¼Œæ¶ˆå¤±åœ¨ç„¡ç›¡çš„é»‘æš—ä¸­...' },
        { emoji: 'âŒ', text: 'æ­¦å™¨æ²’æœ‰ä½œç”¨ï¼éº‹é¹¿ç¸ç”¨é¹¿è§’ä¸€é ‚ï¼Œå°±æŠŠè‹±é›„é ‚é£›åƒæ‰äº†ï¼' },
        { emoji: 'ğŸ˜µ', text: 'éº‹é¹¿ç¸ç™¼å‡ºå‚¬çœ å…‰æ³¢ï¼Œè‹±é›„ç¡è‘—å¾Œå°±è®Šæˆäº†é»å¿ƒ...' },
        { emoji: 'ğŸ•³ï¸', text: 'è¸©åˆ°éº‹é¹¿ç¸è¨­ä¸‹çš„é™·é˜±ï¼Œæ‰é€²æ·±æ·µè¢«åƒæ‰äº†ï¼' },
        { emoji: 'ğŸ’«', text: 'è¢«éº‹é¹¿ç¸çš„çœ¼ç¥è¿·æƒ‘ï¼Œææƒšé–“å°±æˆç‚ºäº†ç‰ çš„é£Ÿç‰©...' },
        { emoji: 'ğŸŒªï¸', text: 'éº‹é¹¿ç¸å¬å–šæš´é¢¨é›ªï¼Œåœ¨é¢¨é›ªä¸­è¿·å¤±æ–¹å‘å¾Œè¢«åå™¬ï¼' },
        { emoji: 'âš¡', text: 'éº‹é¹¿ç¸é‡‹æ”¾é›·é›»ä¹‹åŠ›ï¼Œè¢«é›»æšˆå¾Œå°±è¢«åƒæ‰äº†ï¼' },
        { emoji: 'ğŸ­', text: 'éº‹é¹¿ç¸è®Šèº«æˆè–èª•è€äººï¼Œè‹±é›„æ”¾ä¸‹æˆ’å¿ƒå¾Œå°±è¢«å·è¥²åƒæ‰ï¼' },
        { emoji: 'ğŸŒ‘', text: 'éº‹é¹¿ç¸å‰µé€ é»‘æš—é ˜åŸŸï¼Œåœ¨ä¼¸æ‰‹ä¸è¦‹äº”æŒ‡çš„é»‘æš—ä¸­è¢«çµé£Ÿï¼' },
        { emoji: 'ğŸª¤', text: 'è¢«éº‹é¹¿ç¸çš„ç¦®ç‰©ç‚¸å½ˆç‚¸æšˆï¼Œå€’åœ°å¾Œå°±è¢«åƒæ‰äº†ï¼' },
        { emoji: 'ğŸª', text: 'éº‹é¹¿ç¸ç”¨é­”æ³•è£½é€ å¹»å¢ƒï¼Œè‹±é›„åœ¨å¹»è¦ºä¸­è¿·å¤±å¾Œè¢«åƒæ‰ï¼' },
        { emoji: 'ğŸŒŠ', text: 'éº‹é¹¿ç¸å¬å–šå¯’å†°æ³¢æµªï¼Œè¢«å‡åƒµçš„è‹±é›„æˆç‚ºäº†å†°æ£’é»å¿ƒï¼' },
        { emoji: 'ğŸ¯', text: 'æƒ³è¦åæ“Šä½†å®Œå…¨æ‰“ä¸ä¸­ï¼éº‹é¹¿ç¸éˆæ´»é–ƒèº²å¾Œåæ®ºæˆåŠŸï¼' }
    ];

    // --- åˆå§‹åŒ– ---
    window.onload = function() {
        // PWA Service Worker è¨»å†Š
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }

        loadData();
        renderParticipants();
        
        // å¦‚æœæœ‰ä¸Šæ¬¡æœªå®Œæˆçš„é€²åº¦
        const savedState = localStorage.getItem('xmasState');
        if (savedState) {
            const state = JSON.parse(savedState);
            if (state.step === 'result') {
                showView('view-result');
                renderResults(state.battleHistory);
            }
        }
    };

    // --- é‚è¼¯å‡½æ•¸ ---

    function loadData() {
        const savedPart = localStorage.getItem('xmasParticipants');
        if (savedPart) participants = JSON.parse(savedPart);
        
        const savedCouple = localStorage.getItem('xmasCouple');
        if (savedCouple) couple = JSON.parse(savedCouple);
        
        document.getElementById('couple-1').value = couple.p1;
        document.getElementById('couple-2').value = couple.p2;
        updateCount();
    }

    function renderParticipants() {
        const list = document.getElementById('participants-list');
        list.innerHTML = '';
        participants.forEach((p, index) => {
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 bg-black/20 p-2 rounded';
            div.innerHTML = `
                <span class="w-6 text-center text-gray-400">${index + 1}</span>
                <span class="flex-1 font-bold">${p}</span>
                <button onclick="removeParticipant(${index})" class="text-red-400 hover:text-red-200 px-2">âœ•</button>
            `;
            list.appendChild(div);
        });
        updateCount();
    }

    function addParticipant() {
        const input = document.getElementById('new-name');
        const name = input.value.trim();
        if (name) {
            participants.push(name);
            input.value = '';
            saveConfig();
            renderParticipants();
        }
    }

    function removeParticipant(index) {
        if (participants.length <= 3) {
            alert('è‡³å°‘éœ€è¦ 3 äººæ‰èƒ½é€²è¡ŒéŠæˆ²');
            return;
        }
        participants.splice(index, 1);
        saveConfig();
        renderParticipants();
    }

    function updateCount() {
        document.getElementById('count-display').innerText = `${participants.length}äºº`;
        document.getElementById('story-count').innerText = participants.length;
    }

    function saveConfig() {
        couple.p1 = document.getElementById('couple-1').value.trim();
        couple.p2 = document.getElementById('couple-2').value.trim();
        localStorage.setItem('xmasParticipants', JSON.stringify(participants));
        localStorage.setItem('xmasCouple', JSON.stringify(couple));
    }

    function startStory() {
        saveConfig(); // ç¢ºä¿å¤«å¦»è¨­å®šå·²å„²å­˜
        if (participants.length < 3) return alert('äººæ•¸ä¸è¶³ï¼');
        
        // ç”ŸæˆæŠ½ç±¤é‚è¼¯
        if (!generateDrawOrder()) {
            return alert('ç„¡æ³•ç”Ÿæˆæœ‰æ•ˆçš„æŠ½ç±¤é †åº (å¯èƒ½æ˜¯å¤«å¦»è¨­å®šå°è‡´æ­»çµ)ï¼Œè«‹é‡è©¦ï¼');
        }

        showView('view-story');
    }

    // æ ¸å¿ƒæ¼”ç®—æ³•ï¼šæ´—ç‰Œä¸¦æª¢æŸ¥å¤«å¦»ä¸äº’æŠ½
    function generateDrawOrder() {
        const c1 = couple.p1;
        const c2 = couple.p2;
        let valid = false;
        let attempts = 0;
        let shuffled = [];

        while (!valid && attempts < 2000) {
            shuffled = [...participants];
            // Fisher-Yates Shuffle
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }

            // æª¢æŸ¥é‚è¼¯ï¼šA -> B, B -> C ... Last -> A
            let isChainValid = true;
            for (let i = 0; i < shuffled.length; i++) {
                const giver = shuffled[i];
                const receiver = shuffled[(i + 1) % shuffled.length];
                
                // ç¦æ­¢å¤«å¦»äº’æŠ½
                if ((giver === c1 && receiver === c2) || (giver === c2 && receiver === c1)) {
                    isChainValid = false;
                    break;
                }
            }
            if (isChainValid) valid = true;
            attempts++;
        }

        if (valid) {
            drawOrder = shuffled;
            currentIndex = 0;
            battleHistory = [];
            return true;
        }
        return false;
    }

    function enterDraw() {
        showView('view-drawing');
        setupRound();
    }

    function setupRound() {
        // é‡ç½®ç•«é¢ç‹€æ…‹
        document.getElementById('gift-box-area').classList.remove('hidden');
        document.getElementById('reveal-area').classList.add('hidden');
        document.getElementById('battle-result-area').classList.add('hidden');
        
        const giver = drawOrder[currentIndex];
        document.getElementById('current-giver').innerText = giver;
        document.getElementById('round-number').innerText = currentIndex + 1;
    }

    function revealReceiver() {
        const receiver = drawOrder[(currentIndex + 1) % drawOrder.length];
        
        document.getElementById('gift-box-area').classList.add('hidden');
        document.getElementById('reveal-area').classList.remove('hidden');
        document.getElementById('current-receiver').innerText = receiver;
    }

    function handleFeedback(isSatisfied) {
        const giver = drawOrder[currentIndex];
        const receiver = drawOrder[(currentIndex + 1) % drawOrder.length];
        
        // éš¨æ©Ÿé¸å–è…³æœ¬
        let scenario;
        if (isSatisfied) {
            scenario = victoryScenarios[Math.floor(Math.random() * victoryScenarios.length)];
        } else {
            scenario = defeatScenarios[Math.floor(Math.random() * defeatScenarios.length)];
        }

        // ç´€éŒ„çµæœ
        battleHistory.push({
            giver,
            receiver,
            isSatisfied,
            scenario
        });

        // é¡¯ç¤ºæˆ°é¬¥çµæœ
        document.getElementById('reveal-area').classList.add('hidden');
        document.getElementById('battle-result-area').classList.remove('hidden');
        document.getElementById('battle-emoji').innerText = scenario.emoji;
        document.getElementById('battle-text').innerText = scenario.text;
        
        // å„²å­˜ç•¶å‰ç‹€æ…‹ä»¥å…æ‰‹æ»‘é‡æ•´
        localStorage.setItem('xmasState', JSON.stringify({
            step: 'drawing',
            battleHistory: battleHistory
        }));
    }

    function nextRound() {
        if (currentIndex < drawOrder.length - 1) {
            currentIndex++;
            setupRound();
        } else {
            finishGame();
        }
    }

    function finishGame() {
        localStorage.setItem('xmasState', JSON.stringify({
            step: 'result',
            battleHistory: battleHistory
        }));
        showView('view-result');
        renderResults(battleHistory);
    }

    function renderResults(history) {
        const container = document.getElementById('final-list');
        container.innerHTML = '';

        history.forEach((battle, idx) => {
            const div = document.createElement('div');
            div.className = `p-4 border-b border-gray-200 ${battle.isSatisfied ? 'bg-green-50' : 'bg-red-50'}`;
            
            div.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <div class="font-bold text-lg">
                        <span class="text-gray-600">${battle.giver}</span>
                        <span class="mx-2 text-gray-400">âœ</span>
                        <span class="text-blue-600">${battle.receiver}</span>
                    </div>
                    <div class="text-2xl">${battle.isSatisfied ? 'âœ…' : 'ğŸ’€'}</div>
                </div>
                <div class="text-sm text-gray-600 italic">
                    ${battle.scenario.emoji} ${battle.scenario.text}
                </div>
            `;
            container.appendChild(div);
        });
    }

    function resetData() {
        if(confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç´€éŒ„é‡æ–°é–‹å§‹å—ï¼Ÿ')) {
            localStorage.removeItem('xmasState');
            localStorage.removeItem('xmasParticipants');
            localStorage.removeItem('xmasCouple');
            location.reload();
        }
    }

    function downloadScreenshot() {
        alert('è«‹ä½¿ç”¨æ‰‹æ©Ÿå…§å»ºæˆªåœ–åŠŸèƒ½ä¿å­˜çµæœï¼(ç¶²é ç‰ˆè‡ªå‹•æˆªåœ–ç›¸å®¹æ€§è¼ƒä½)');
    }

    // --- å·¥å…· ---
    function showView(id) {
        ['view-setup', 'view-story', 'view-drawing', 'view-result'].forEach(v => {
            document.getElementById(v).classList.add('hidden');
        });
        document.getElementById(id).classList.remove('hidden');
    }
</script>

</body>
</html>