<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è–èª•éº‹é¹¿å†’éšªï¼šè¦å»å“ªå€‹åœ‹å®¶æ“¾äº‚å‘¢</title>
    <meta name="theme-color" content="#7f1d1d">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.jpg">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; overflow-x: hidden; touch-action: manipulation; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- æ ¸å¿ƒå‹•ç•«å€ --- */

        /* 1. éº‹é¹¿ç¸è¢«æ‰“å€’ (å“­è‘—é£›èµ°) */
        .monster-die { animation: monsterDie 1.5s forwards ease-in-out; }
        @keyframes monsterDie {
            0% { transform: scale(1); filter: none; }
            10%, 30% { transform: translate(-10px, 0) rotate(-5deg); filter: brightness(1.2); }
            20%, 40% { transform: translate(10px, 0) rotate(5deg); }
            100% { transform: scale(0) rotate(720deg) translateY(-800px); opacity: 0; }
        }

        /* 2. éº‹é¹¿ç¸æ”»æ“Š (ç”Ÿæ°£ç•™åœ¨åŸåœ°) */
        .monster-attack-stay { animation: monsterAttackStay 0.8s forwards cubic-bezier(0.25, 1, 0.5, 1); }
        @keyframes monsterAttackStay {
            0% { transform: scale(1) translateY(0); filter: none; }
            40% { transform: scale(0.9) translateY(-10px); } /* è“„åŠ› */
            100% { 
                transform: scale(1.3) translateY(40px); /* å¾€å‰å£“è¿« */
                filter: drop-shadow(0 0 20px red) brightness(1.1); 
                z-index: 30; 
            }
        }

        /* 3. è‹±é›„ - å‘¼å¸å¾…æ©Ÿ */
        .hero-idle { animation: heroIdle 2s infinite ease-in-out; }
        @keyframes heroIdle {
            0%, 100% { transform: scale(1); filter: drop-shadow(0 0 5px rgba(255,255,255,0.5)); }
            50% { transform: scale(1.05); filter: drop-shadow(0 0 15px rgba(255,255,255,0.8)); }
        }

        /* --- è‹±é›„çš„ 5 ç¨®æ­»æ³• --- */
        .hero-fly-away { animation: heroFly 1.2s forwards ease-in; }
        @keyframes heroFly {
            0% { transform: scale(1) rotate(0); opacity: 1; }
            20% { transform: scale(1.2) rotate(-10deg) translate(0, 10px); filter: hue-rotate(90deg); opacity: 1; }
            100% { transform: scale(0) rotate(1080deg) translate(500px, -500px); opacity: 0; }
        }

        .hero-dead { animation: heroDead 1.5s forwards ease-out; }
        @keyframes heroDead {
            0% { transform: scale(1); filter: none; opacity: 1; }
            10% { transform: translate(-5px, 5px); filter: grayscale(1) contrast(200%) brightness(0.5) sepia(100%) hue-rotate(-50deg) saturate(500%); opacity: 1; }
            40% { transform: rotate(-10deg); filter: grayscale(1); opacity: 0.8; }
            100% { transform: rotate(90deg) translateY(50px); filter: grayscale(1); opacity: 0; }
        }

        .hero-flatten { animation: heroFlatten 0.4s forwards cubic-bezier(0.25, 1, 0.5, 1); }
        @keyframes heroFlatten {
            0% { transform: scale(1, 1); opacity: 1; }
            50% { transform: scale(1.4, 0.6) translateY(20px); opacity: 1; }
            100% { transform: scale(2, 0.05) translateY(100px); filter: brightness(0); opacity: 0.5; }
        }

        .hero-spiral { animation: heroSpiral 1s forwards ease-in; }
        @keyframes heroSpiral {
            0% { transform: scale(1) rotate(0); opacity: 1; }
            100% { transform: scale(0) rotate(720deg); filter: contrast(200%); opacity: 0; }
        }

        .hero-drop { animation: heroDrop 0.8s forwards ease-in; }
        @keyframes heroDrop {
            0% { transform: translateY(0) rotate(0); opacity: 1; }
            20% { transform: translateY(-30px) rotate(-5deg); }
            100% { transform: translateY(1000px) rotate(45deg); opacity: 0; }
        }

        .effect-hit { animation: effectHit 0.6s forwards; z-index: 60; }
        @keyframes effectHit {
            0% { transform: scale(0) rotate(-45deg); opacity: 0; }
            50% { transform: scale(2) rotate(0deg); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        .shake-light { animation: shakeLight 0.2s infinite; }
        @keyframes shakeLight { 0% { transform: translate(1px, 0); } 50% { transform: translate(-1px, 0); } 100% { transform: translate(0, 0); } }

    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-red-900 via-green-900 to-blue-900 text-white select-none">

<div id="app" class="max-w-md mx-auto min-h-screen p-4 flex flex-col relative overflow-hidden">
    
    <header class="text-center py-4 mb-2 z-10">
        <div class="w-24 h-24 mx-auto mb-2 rounded-full overflow-hidden border-4 border-yellow-400 shadow-lg relative bg-black/20">
            <img src="icon.jpg" alt="éº‹é¹¿ç¸" class="w-full h-full object-cover">
        </div>
        <h1 class="text-2xl font-bold text-yellow-300 drop-shadow-md tracking-wider">ğŸ¦Œ è–èª•åŠ« ğŸ„</h1>
    </header>

    <div id="view-setup" class="flex-1 fade-in z-20 overflow-y-auto">
        <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 shadow-xl border border-white/20">
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <span>ğŸ›¡ï¸ è‹±é›„åå–®</span>
                <span id="count-display" class="ml-auto text-sm bg-red-600 px-2 py-1 rounded-full">15äºº</span>
            </h2>
            
            <div id="participants-list" class="space-y-2 max-h-60 overflow-y-auto mb-4 pr-1">
                </div>

            <div class="flex gap-2 mb-2">
                <input type="text" id="new-name" placeholder="è¼¸å…¥æ–°è‹±é›„" class="flex-1 bg-white/20 border border-white/30 rounded px-3 py-2 text-white placeholder-gray-300 focus:outline-none focus:border-yellow-400">
                <button id="gender-toggle" onclick="toggleGender()" class="w-12 bg-blue-600 rounded text-xl flex items-center justify-center">ğŸš¹</button>
            </div>
            <button onclick="addParticipant()" class="w-full bg-green-600 hover:bg-green-500 py-2 rounded font-bold shadow mb-6">ï¼‹ æ–°å¢</button>

            <div class="border-t border-white/20 pt-4 mb-6">
                <h3 class="text-lg font-bold mb-2 text-pink-300">â¤ï¸ ç¦å¿Œä¹‹æˆ€ â¤ï¸</h3>
                <div class="flex gap-2">
                    <input type="text" id="couple-1" value="ç´«ç’‡" class="w-1/2 bg-pink-900/40 border border-pink-500/50 rounded px-3 py-2 text-center">
                    <span class="py-2 text-pink-400">âš¡</span>
                    <input type="text" id="couple-2" value="æ™ºå ¯" class="w-1/2 bg-pink-900/40 border border-pink-500/50 rounded px-3 py-2 text-center">
                </div>
            </div>

            <button onclick="startStory()" class="w-full bg-gradient-to-r from-yellow-500 to-red-600 py-4 rounded-xl text-xl font-bold shadow-lg transform active:scale-95 transition-all">
                âš”ï¸ é–‹å§‹å†’éšª
            </button>
            
            <div class="mt-4 text-center">
                 <button onclick="resetData()" class="text-xs text-gray-400 underline">æ¸…é™¤ç´€éŒ„é‡ç½®</button>
            </div>
        </div>
    </div>

    <div id="view-story" class="hidden flex-1 flex flex-col justify-center items-center text-center fade-in p-4 z-20">
        <div class="bg-black/60 p-6 rounded-xl border border-red-500/50 shadow-2xl backdrop-blur">
            <div class="w-32 h-32 mx-auto mb-4 rounded-full overflow-hidden border-4 border-red-500 shadow-lg">
                <img src="icon.jpg" class="w-full h-full object-cover animate-pulse">
            </div>
            <h2 class="text-2xl font-bold text-red-400 mb-4">âš ï¸ è­¦å ±ï¼šç½é›£é™è‡¨</h2>
            <p class="text-lg leading-relaxed mb-6 text-gray-100 text-left">
                é£¢é¤“å·²ä¹…çš„<b>éº‹é¹¿ç¸</b>ç”¦é†’äº†...<br>
                é€™ <span id="story-count" class="text-yellow-400 font-bold">15</span> ä½è‹±é›„å€‘æ˜¯å¦èƒ½å¤ ç¶­æŒå’Œå¹³å‘¢ï¼Ÿ<br>
                é‚„æ˜¯æœƒæˆç‚ºç‰ çš„è–èª•å¤§é¤ï¼Ÿ<br><br>
                å‘½é‹çš„è½‰ç›¤å·²ç¶“é–‹å§‹è½‰å‹•...
            </p>
            <button onclick="enterDraw()" class="bg-red-600 hover:bg-red-500 text-white px-10 py-3 rounded-full font-bold text-xl animate-bounce shadow-lg ring-4 ring-red-900">
                é€²å…¥æˆ°å ´
            </button>
        </div>
    </div>

    <div id="view-drawing" class="hidden flex-1 flex flex-col fade-in z-20 h-full">
        <div class="text-center mb-2 flex justify-between items-center px-4">
            <div class="bg-blue-900/80 px-3 py-1 rounded-full text-xs border border-blue-400">
                Round <span id="round-number">1</span>
            </div>
            <h2 class="text-lg font-bold">
                è´ˆç¦®è€…ï¼š<span id="current-giver" class="text-yellow-300">è‹±é›„A</span>
            </h2>
        </div>

        <div id="gift-box-area" class="flex-1 flex flex-col items-center justify-center cursor-pointer pb-20" onclick="revealReceiver()">
            <div class="text-9xl animate-bounce drop-shadow-[0_10px_10px_rgba(0,0,0,0.5)]">ğŸ</div>
            <p class="mt-8 text-2xl animate-pulse text-yellow-200 font-bold">é»æ“Šé–‹å•Ÿç¦®ç‰©</p>
        </div>

        <div id="reveal-area" class="hidden flex-1 flex flex-col items-center justify-center pb-10">
            <p class="text-gray-300 text-sm mb-2">ç¦®ç‰©æ˜¯é€çµ¦...</p>
            <div class="text-5xl font-bold text-green-400 mb-8 drop-shadow-lg scale-110" id="current-receiver">
                è‹±é›„B
            </div>
            
            <div class="w-full bg-white/10 backdrop-blur rounded-xl p-6 border border-white/20">
                <p class="text-center mb-4 text-lg font-bold">è‹±é›„æ˜¯å¦æ»¿æ„ï¼Ÿ</p>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="handleFeedback(true)" class="bg-green-600 hover:bg-green-500 py-6 rounded-xl font-bold flex flex-col items-center gap-2 transform active:scale-95 transition shadow-lg border-b-4 border-green-800">
                        <span class="text-4xl">âš”ï¸</span>
                        <span>æ»¿æ„</span>
                    </button>
                    <button onclick="handleFeedback(false)" class="bg-red-600 hover:bg-red-500 py-6 rounded-xl font-bold flex flex-col items-center gap-2 transform active:scale-95 transition shadow-lg border-b-4 border-red-800">
                        <span class="text-4xl">ğŸ˜±</span>
                        <span>ä¸æ»¿æ„</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="battle-result-area" class="hidden flex-1 flex flex-col justify-between py-4 relative">
            
            <div class="flex-1 flex items-center justify-center relative z-30">
                <div class="w-48 h-48 relative">
                    <img src="icon.jpg" id="monster-img" class="w-full h-full rounded-full object-cover border-4 border-red-500 shadow-[0_0_30px_rgba(255,0,0,0.5)] z-10 relative">
                    <div id="effect-overlay" class="absolute inset-0 flex items-center justify-center text-9xl z-50 pointer-events-none opacity-0">ğŸ’¥</div>
                </div>
            </div>

            <div class="px-4 py-2 z-30">
                <div class="bg-black/60 backdrop-blur border border-yellow-500/50 rounded-lg p-3 text-center min-h-[80px] flex items-center justify-center">
                    <p id="battle-text" class="text-lg font-bold text-white leading-relaxed"></p>
                </div>
            </div>

            <div class="flex-1 flex flex-col items-center justify-end pb-4 relative">
                <div class="w-40 h-40 mb-2 relative group z-20">
                    <img id="hero-img" src="" class="w-full h-full object-cover rounded-xl border-2 border-white/50 shadow-2xl hero-idle">
                    <div id="hero-damage-overlay" class="absolute inset-0 bg-red-600 mix-blend-overlay opacity-0 rounded-xl"></div>
                </div>
                
                <h3 id="battle-hero-name" class="text-2xl font-bold text-yellow-300 drop-shadow-md bg-black/30 px-4 py-1 rounded-full z-20">
                    è‹±é›„å
                </h3>
            </div>

            <div class="absolute bottom-4 right-4 z-50">
                <button onclick="nextRound()" class="bg-yellow-500 hover:bg-yellow-400 text-black font-bold px-6 py-3 rounded-full shadow-xl animate-bounce">
                    ä¸‹ä¸€ä½ âœ
                </button>
            </div>
        </div>
    </div>

    <div id="view-result" class="hidden flex-1 fade-in z-20 pb-10">
        <h2 class="text-2xl font-bold text-center mb-6 text-yellow-300">ğŸ“œ æˆ°å½¹ç´€éŒ„</h2>
        
        <div class="bg-white/90 text-gray-900 rounded-xl shadow-2xl overflow-hidden mb-4">
            <div class="max-h-[60vh] overflow-y-auto" id="final-list">
                </div>
        </div>

        <div class="flex gap-3">
            <button onclick="resetData()" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 rounded-lg shadow text-center">
                ğŸ”„ é‡æ–°é–‹å§‹
            </button>
        </div>
    </div>

</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        const now = audioCtx.currentTime;

        if (type === 'attack') { 
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(100, now);
            osc.frequency.linearRampToValueAtTime(50, now + 0.5);
            gainNode.gain.setValueAtTime(0.2, now);
            gainNode.gain.linearRampToValueAtTime(0, now + 0.5);
            osc.start(now);
            osc.stop(now + 0.5);
        } else if (type === 'hit') { 
            osc.type = 'square';
            osc.frequency.setValueAtTime(150, now);
            osc.frequency.exponentialRampToValueAtTime(0.01, now + 0.3);
            gainNode.gain.setValueAtTime(0.5, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            osc.start(now);
            osc.stop(now + 0.3);
        } else if (type === 'sword') { 
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(600, now);
            osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
            gainNode.gain.setValueAtTime(0.3, now);
            gainNode.gain.linearRampToValueAtTime(0, now + 0.1);
            osc.start(now);
            osc.stop(now + 0.1);
        } else if (type === 'win') { 
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(440, now);
            osc.frequency.setValueAtTime(554, now + 0.1);
            osc.frequency.setValueAtTime(659, now + 0.2);
            gainNode.gain.setValueAtTime(0.2, now);
            gainNode.gain.linearRampToValueAtTime(0, now + 0.6);
            osc.start(now);
            osc.stop(now + 0.6);
        }
    }
</script>

<script>
    // --- 1. è³‡æ–™è¨­å®š ---
    const defaultParticipants = [
        'æ™¨è±ª', 'ä½³ç‘œ', 'å¿µæ…ˆ', 'è© ç­‘', 'æƒ å­', 
        'äº­æ½”', 'å£«å®¶', 'å† å®‡', 'æ•æ¯“', 'æŸèŒµ', 
        'è‹±ç­‘', 'ç´«ç’‡', 'æ™ºå ¯', 'éŠ˜ç·¯', 'è‚²å§'
    ];
    
    const genderData = {
        'æ™¨è±ª': 'M', 'ä½³ç‘œ': 'F', 'å¿µæ…ˆ': 'F', 'è© ç­‘': 'M', 'æƒ å­': 'F',
        'äº­æ½”': 'F', 'å£«å®¶': 'M', 'å† å®‡': 'M', 'æ•æ¯“': 'F', 'æŸèŒµ': 'F',
        'è‹±ç­‘': 'F', 'ç´«ç’‡': 'F', 'æ™ºå ¯': 'M', 'éŠ˜ç·¯': 'M', 'è‚²å§': 'F'
    };

    const maleGroupMap = {
        'æ™ºå ¯': 'boy_a.jpg', 
        'å† å®‡': 'boy_b.jpg', 'è© ç­‘': 'boy_b.jpg',
        'æ™¨è±ª': 'boy_c.jpg', 'å£«å®¶': 'boy_c.jpg',
        'éŠ˜ç·¯': 'boy_d.jpg'
    };

    const femaleGroupMap = {
        'ä½³ç‘œ': 'girl_a.jpg',
        'å¿µæ…ˆ': 'girl_b.jpg', 'è‚²å§': 'girl_b.jpg', 'æƒ å­': 'girl_b.jpg', 'è‹±ç­‘': 'girl_b.jpg',
        'ç´«ç’‡': 'girl_c.jpg',
        'æŸèŒµ': 'girl_d.jpg',
        'æ•æ¯“': 'girl_e.jpg', 'äº­æ½”': 'girl_e.jpg'
    };

    let participants = [...defaultParticipants];
    let couple = { p1: 'ç´«ç’‡', p2: 'æ™ºå ¯' };
    let drawOrder = [];
    let currentIndex = 0;
    let battleHistory = [];
    let tempNewGender = 'M';

    const victoryScenarios = [
        { emoji: 'âš”ï¸', text: 'ä¸€åŠæ–¬æ–·äº†éº‹é¹¿ç¸çš„é¹¿è§’ï¼' },
        { emoji: 'ğŸ”¥', text: 'è–èª•ç«ç„°å°‡éº‹é¹¿ç¸çƒ¤æˆäº†ç‰›æ’ï¼' },
        { emoji: 'â„ï¸', text: 'å†°é›ªé­”æ³•æŠŠéº‹é¹¿ç¸å‡æˆäº†å†°é›•ï¼' },
        { emoji: 'ğŸ‘Š', text: 'ä¸€è¨˜ä¸Šå‹¾æ‹³æŠŠéº‹é¹¿ç¸æ‰“é£›åˆ°æœˆçƒï¼' },
        { emoji: 'ğŸ…', text: 'å¬å–šè–èª•è€äººæŠŠéº‹é¹¿ç¸æŠ“å›å»åŠ ç­ï¼' }
    ];

    const defeatScenarios = [
        { emoji: 'ğŸ˜±', text: 'é‚„æ²’åæ‡‰éä¾†å°±è¢«ä¸€å£åæ‰äº†ï¼' },
        { emoji: 'ğŸ’¨', text: 'æƒ³é€ƒè·‘ä½†è¢«éº‹é¹¿ç¸ä¸€è…³è¸©æ‰ï¼' },
        { emoji: 'ğŸ˜µ', text: 'è¢«éº‹é¹¿ç¸çš„å‚¬çœ å…‰æ³¢è®Šæˆäº†é»å¿ƒï¼' },
        { emoji: 'ğŸ”¨', text: 'æ­¦å™¨æ–·è£‚ï¼Œè¢«éº‹é¹¿ç¸æ’é£›å‡ºåœ°çƒï¼' },
        { emoji: 'ğŸ–', text: 'è¢«ç•¶æˆè–èª•å¤§é¤åƒå¾—ä¹¾ä¹¾æ·¨æ·¨ï¼' }
    ];

    // --- 2. åˆå§‹åŒ– ---
    window.onload = function() {
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }
        loadData();
        renderParticipants();
        
        const savedState = localStorage.getItem('xmasState');
        if (savedState) {
            const state = JSON.parse(savedState);
            if (state.step === 'result') {
                showView('view-result');
                renderResults(state.battleHistory);
            }
        }
    };

    // --- 3. é‚è¼¯å‡½æ•¸ ---
    function loadData() {
        const savedPart = localStorage.getItem('xmasParticipants');
        if (savedPart) participants = JSON.parse(savedPart);
        const savedGender = localStorage.getItem('xmasGender');
        if (savedGender) Object.assign(genderData, JSON.parse(savedGender));
        const savedCouple = localStorage.getItem('xmasCouple');
        if (savedCouple) couple = JSON.parse(savedCouple);
        
        document.getElementById('couple-1').value = couple.p1;
        document.getElementById('couple-2').value = couple.p2;
        updateCount();
    }

    function renderParticipants() {
        const list = document.getElementById('participants-list');
        list.innerHTML = '';
        participants.forEach((p, index) => {
            const g = genderData[p] || 'M';
            const badge = g === 'M' ? 'bg-blue-600' : 'bg-pink-600';
            const icon = g === 'M' ? 'ğŸš¹' : 'ğŸšº';
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 bg-black/20 p-2 rounded hover:bg-black/30 transition';
            div.innerHTML = `
                <span class="w-6 text-center text-gray-400 font-mono">${index + 1}</span>
                <span class="${badge} text-xs px-1 rounded">${icon}</span>
                <span class="flex-1 font-bold tracking-wide">${p}</span>
                <button onclick="removeParticipant(${index})" class="text-red-400 hover:text-red-200 px-3 font-bold">âœ•</button>
            `;
            list.appendChild(div);
        });
        updateCount();
    }

    function toggleGender() {
        const btn = document.getElementById('gender-toggle');
        if (tempNewGender === 'M') {
            tempNewGender = 'F';
            btn.innerText = 'ğŸšº';
            btn.className = 'w-12 bg-pink-600 rounded text-xl flex items-center justify-center';
        } else {
            tempNewGender = 'M';
            btn.innerText = 'ğŸš¹';
            btn.className = 'w-12 bg-blue-600 rounded text-xl flex items-center justify-center';
        }
    }

    function addParticipant() {
        const input = document.getElementById('new-name');
        const name = input.value.trim();
        if (name) {
            participants.push(name);
            genderData[name] = tempNewGender;
            input.value = '';
            saveConfig();
            renderParticipants();
        }
    }

    function removeParticipant(index) {
        if (participants.length <= 3) return alert('äººæ•¸éå°‘');
        const name = participants[index];
        participants.splice(index, 1);
        delete genderData[name];
        saveConfig();
        renderParticipants();
    }

    function updateCount() {
        document.getElementById('count-display').innerText = `${participants.length}äºº`;
        document.getElementById('story-count').innerText = participants.length;
    }

    function saveConfig() {
        couple.p1 = document.getElementById('couple-1').value.trim();
        couple.p2 = document.getElementById('couple-2').value.trim();
        localStorage.setItem('xmasParticipants', JSON.stringify(participants));
        localStorage.setItem('xmasGender', JSON.stringify(genderData));
        localStorage.setItem('xmasCouple', JSON.stringify(couple));
    }

    function startStory() {
        saveConfig();
        if (participants.length < 3) return alert('äººæ•¸ä¸è¶³ï¼');
        if (!generateDrawOrder()) return alert('ç„¡æ³•ç”Ÿæˆæœ‰æ•ˆé †åº');
        showView('view-story');
    }

    function generateDrawOrder() {
        const c1 = couple.p1;
        const c2 = couple.p2;
        let valid = false;
        let attempts = 0;
        let shuffled = [];
        while (!valid && attempts < 2000) {
            shuffled = [...participants];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            let isChainValid = true;
            for (let i = 0; i < shuffled.length; i++) {
                const giver = shuffled[i];
                const receiver = shuffled[(i + 1) % shuffled.length];
                if ((giver === c1 && receiver === c2) || (giver === c2 && receiver === c1)) {
                    isChainValid = false;
                    break;
                }
            }
            if (isChainValid) valid = true;
            attempts++;
        }
        if (valid) {
            drawOrder = shuffled;
            currentIndex = 0;
            battleHistory = [];
            return true;
        }
        return false;
    }

    function enterDraw() {
        showView('view-drawing');
        setupRound();
    }

    function getHeroImage(name) {
        const gender = genderData[name] || 'M';
        if (gender === 'M') return maleGroupMap[name] || 'boy_b.jpg';
        else return femaleGroupMap[name] || 'girl_a.jpg';
    }

    function setupRound() {
        document.getElementById('gift-box-area').classList.remove('hidden');
        document.getElementById('reveal-area').classList.add('hidden');
        document.getElementById('battle-result-area').classList.add('hidden');
        
        const monsterImg = document.getElementById('monster-img');
        const heroImg = document.getElementById('hero-img');
        const effectOverlay = document.getElementById('effect-overlay');
        
        monsterImg.src = 'icon.jpg'; // é‡ç½®
        monsterImg.className = 'w-full h-full rounded-full object-cover border-4 border-red-500 shadow-xl z-10 relative';
        
        heroImg.className = 'w-full h-full object-cover rounded-xl border-2 border-white/50 shadow-2xl hero-idle';
        effectOverlay.className = 'absolute inset-0 flex items-center justify-center text-9xl z-50 pointer-events-none opacity-0';

        const giver = drawOrder[currentIndex];
        document.getElementById('current-giver').innerText = giver;
        document.getElementById('round-number').innerText = currentIndex + 1;
    }

    function revealReceiver() {
        const receiver = drawOrder[(currentIndex + 1) % drawOrder.length];
        document.getElementById('gift-box-area').classList.add('hidden');
        document.getElementById('reveal-area').classList.remove('hidden');
        document.getElementById('current-receiver').innerText = receiver;
        
        const imgPath = getHeroImage(receiver);
        document.getElementById('hero-img').src = imgPath;
        document.getElementById('battle-hero-name').innerText = receiver;
    }

    function handleFeedback(isSatisfied) {
        const giver = drawOrder[currentIndex];
        const receiver = drawOrder[(currentIndex + 1) % drawOrder.length];
        
        let scenario;
        const monsterImg = document.getElementById('monster-img');
        const heroImg = document.getElementById('hero-img');
        const effectOverlay = document.getElementById('effect-overlay');
        const battleText = document.getElementById('battle-text');
        
        document.getElementById('reveal-area').classList.add('hidden');
        document.getElementById('battle-result-area').classList.remove('hidden');
        
        if (!isSatisfied) {
            // ä¸æ»¿æ„ -> æ›æˆé€ç¦®è€…ç…§ç‰‡
            battleText.innerText = `éº‹é¹¿ç¸è¦ºå¾—ç¦®ç‰©å¤ªçˆ›ï¼Œæ±ºå®šæ”¹åƒæ‰ ${giver}...`;
            heroImg.src = getHeroImage(giver);
            document.getElementById('battle-hero-name').innerText = giver;
        } else {
            // æ»¿æ„
            battleText.innerText = "è‹±é›„æº–å‚™åæ“Š...";
        }
        
        if (!isSatisfied) heroImg.classList.add('shake-light');

        setTimeout(() => {
            heroImg.classList.remove('shake-light');
            
            if (isSatisfied) {
                // å‹åˆ©ï¼šè®Šå“­è‡‰ -> é£›èµ°
                scenario = victoryScenarios[Math.floor(Math.random() * victoryScenarios.length)];
                battleText.innerText = scenario.text;
                effectOverlay.innerText = scenario.emoji;
                
                playSound('sword');
                effectOverlay.classList.add('effect-hit');
                
                setTimeout(() => {
                    monsterImg.src = 'monster_dead.jpg'; // åˆ‡æ›å“­å“­è‡‰
                    monsterImg.classList.add('monster-die');
                    playSound('win');
                }, 300);

            } else {
                // å¤±æ•—ï¼šè®Šç”Ÿæ°£è‡‰ -> åŸåœ°æ”»æ“Š -> é€ç¦®è€…æ¶ˆå¤±
                scenario = defeatScenarios[Math.floor(Math.random() * defeatScenarios.length)];
                battleText.innerText = scenario.text;
                
                playSound('attack'); 
                
                monsterImg.src = 'monster_angry.jpg'; // åˆ‡æ›ç”Ÿæ°£è‡‰
                monsterImg.classList.add('monster-attack-stay'); 
                
                setTimeout(() => {
                    playSound('hit');
                    heroImg.classList.remove('hero-idle');
                    
                    const deaths = ['hero-fly-away', 'hero-dead', 'hero-flatten', 'hero-spiral', 'hero-drop'];
                    const randomDeath = deaths[Math.floor(Math.random() * deaths.length)];
                    heroImg.classList.add(randomDeath);
                    
                    document.getElementById('hero-damage-overlay').classList.add('anim-damage');
                }, 500); 
            }

            battleHistory.push({ giver, receiver, isSatisfied, scenario });
            localStorage.setItem('xmasState', JSON.stringify({ step: 'drawing', battleHistory: battleHistory }));

        }, 800);
    }

    function nextRound() {
        if (currentIndex < drawOrder.length - 1) {
            currentIndex++;
            setupRound();
        } else {
            finishGame();
        }
    }

    function finishGame() {
        localStorage.setItem('xmasState', JSON.stringify({ step: 'result', battleHistory: battleHistory }));
        showView('view-result');
        renderResults(battleHistory);
    }

    function renderResults(history) {
        const container = document.getElementById('final-list');
        container.innerHTML = '';
        history.forEach((battle) => {
            const div = document.createElement('div');
            div.className = `p-4 border-b border-gray-200 ${battle.isSatisfied ? 'bg-green-50' : 'bg-red-50'}`;
            // çµæœé é¡¯ç¤ºï¼š
            const resultText = battle.isSatisfied ? 'âœ… æˆåŠŸæ“Šé€€' : `ğŸ’€ ${battle.giver} è¢«åƒäº†`;
            
            div.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <div class="font-bold text-lg">
                        <span class="text-gray-600">${battle.giver}</span>
                        <span class="mx-2 text-gray-400">âœ</span>
                        <span class="text-blue-600">${battle.receiver}</span>
                    </div>
                    <div class="text-sm font-bold ${battle.isSatisfied ? 'text-green-600' : 'text-red-600'}">${resultText}</div>
                </div>
                <div class="text-sm text-gray-600 italic">
                    ${battle.scenario.emoji} ${battle.scenario.text}
                </div>
            `;
            container.appendChild(div);
        });
    }

    function resetData() {
        if(confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç´€éŒ„é‡æ–°é–‹å§‹å—ï¼Ÿ')) {
            localStorage.removeItem('xmasState');
            localStorage.removeItem('xmasParticipants');
            localStorage.removeItem('xmasCouple');
            localStorage.removeItem('xmasGender');
            location.reload();
        }
    }

    function showView(id) {
        ['view-setup', 'view-story', 'view-drawing', 'view-result'].forEach(v => {
            document.getElementById(v).classList.add('hidden');
        });
        document.getElementById(id).classList.remove('hidden');
    }
</script>

</body>
</html>
