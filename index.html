<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è–èª•éº‹é¹¿å†’éšªï¼šè¦å»å“ªå€‹åœ‹å®¶æ“¾äº‚å‘¢</title>
    <meta name="theme-color" content="#7f1d1d">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.jpg">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; overflow-x: hidden; touch-action: manipulation; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- æ ¸å¿ƒå‹•ç•«å€ (å·²ä¿®æ”¹ç‚ºåŸåœ°ç™¼ç´…è®Šå¤§) --- */
        
        /* 1. éº‹é¹¿æˆ°æ•— (é€™å€‹ä¸å‹•) */
        .monster-die { animation: monsterDie 1.5s forwards ease-in-out; }
        @keyframes monsterDie {
            0% { transform: scale(1); filter: none; }
            10%, 30% { transform: translate(-10px, 0) rotate(-5deg); filter: brightness(1.2); }
            20%, 40% { transform: translate(10px, 0) rotate(5deg); }
            100% { transform: scale(0) rotate(720deg) translateY(-800px); opacity: 0; }
        }

        /* 2. [é—œéµä¿®æ”¹] éº‹é¹¿æš´æ€’æ”»æ“Š (åŸåœ°è®Šç´…ã€è®Šå¤§ã€ä¸ä½ç§») */
        .monster-enrage { animation: monsterEnrage 0.8s forwards ease-out; }
        @keyframes monsterEnrage {
            0% { transform: scale(1); filter: none; }
            10% { transform: scale(1.05); filter: sepia(1) saturate(300%) hue-rotate(-50deg); } /* é–‹å§‹è®Šç´… */
            50% { 
                transform: scale(1.15); /* æ”¾å¤§ */
                filter: sepia(1) saturate(500%) hue-rotate(-50deg) drop-shadow(0 0 20px red); /* é®®ç´… + ç´…å…‰ */
            }
            100% { 
                transform: scale(1.1); /* ä¿æŒç¨å¤§ */
                filter: sepia(1) saturate(500%) hue-rotate(-50deg) drop-shadow(0 0 10px darkred); 
            }
        }

        /* 3. è‹±é›„å‹•ç•« (ä¿æŒåŸæ¨£) */
        .hero-idle { animation: heroIdle 2s infinite ease-in-out; }
        @keyframes heroIdle {
            0%, 100% { transform: scale(1); filter: drop-shadow(0 0 5px rgba(255,255,255,0.5)); }
            50% { transform: scale(1.05); filter: drop-shadow(0 0 15px rgba(255,255,255,0.8)); }
        }

        .hero-fly-away { animation: heroFly 1.2s forwards ease-in; }
        @keyframes heroFly {
            0% { transform: scale(1) rotate(0); opacity: 1; }
            20% { transform: scale(1.2) rotate(-10deg) translate(0, 10px); filter: hue-rotate(90deg); opacity: 1; }
            100% { transform: scale(0) rotate(1080deg) translate(500px, -500px); opacity: 0; }
        }

        .hero-dead { animation: heroDead 1.5s forwards ease-out; }
        @keyframes heroDead {
            0% { transform: scale(1); filter: none; opacity: 1; }
            10% { transform: translate(-5px, 5px); filter: grayscale(1) contrast(200%) brightness(0.5) sepia(100%) hue-rotate(-50deg) saturate(500%); opacity: 1; }
            40% { transform: rotate(-10deg); filter: grayscale(1); opacity: 0.8; }
            100% { transform: rotate(90deg) translateY(50px); filter: grayscale(1); opacity: 0; }
        }

        .hero-flatten { animation: heroFlatten 0.4s forwards cubic-bezier(0.25, 1, 0.5, 1); }
        @keyframes heroFlatten {
            0% { transform: scale(1, 1); opacity: 1; }
            50% { transform: scale(1.4, 0.6) translateY(20px); opacity: 1; }
            100% { transform: scale(2, 0.05) translateY(100px); filter: brightness(0); opacity: 0.5; }
        }

        .hero-spiral { animation: heroSpiral 1s forwards ease-in; }
        @keyframes heroSpiral {
            0% { transform: scale(1) rotate(0); opacity: 1; }
            100% { transform: scale(0) rotate(720deg); filter: contrast(200%); opacity: 0; }
        }

        .hero-drop { animation: heroDrop 0.8s forwards ease-in; }
        @keyframes heroDrop {
            0% { transform: translateY(0) rotate(0); opacity: 1; }
            20% { transform: translateY(-30px) rotate(-5deg); }
            100% { transform: translateY(1000px) rotate(45deg); opacity: 0; }
        }

        .effect-hit { animation: effectHit 0.6s forwards; z-index: 60; }
        @keyframes effectHit {
            0% { transform: scale(0) rotate(-45deg); opacity: 0; }
            50% { transform: scale(2) rotate(0deg); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        .shake-light { animation: shakeLight 0.2s infinite; }
        @keyframes shakeLight { 0% { transform: translate(1px, 0); } 50% { transform: translate(-1px, 0); } 100% { transform: translate(0, 0); } }

        /* æ–°å¢ç¦®ç‰©ç›’æ–æ™ƒå‹•ç•« (Wobble) */
        .gift-shake { animation: giftShake 0.5s infinite; }
        @keyframes giftShake {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(5deg); }
            50% { transform: rotate(0deg); }
            75% { transform: rotate(-5deg); }
            100% { transform: rotate(0deg); }
        }

        /* æº«å’Œé–ƒçˆ */
        .animate-pulse-gentle { animation: pulseGentle 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulseGentle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.02); }
        }


        /* ç§‹é¢¨è½è‘‰é®ç½© (æ†‚å‚·ä½†å”¯ç¾) */
        .autumn-overlay {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle, transparent 40%, rgba(139, 69, 19, 0.4) 90%); /* æ·±è¤è‰² */
            z-index: 40;
            animation: pulseAutumn 4s infinite ease-in-out;
            pointer-events: none;
        }
        @keyframes pulseAutumn {
            0%, 100% { opacity: 0.6; filter: sepia(0.5); }
            50% { opacity: 0.8; filter: sepia(0.8); }
        }

    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-red-900 via-green-900 to-blue-900 text-white select-none">

<div id="app" class="max-w-md mx-auto min-h-screen p-4 flex flex-col relative overflow-hidden">
    <canvas id="confetti-canvas" class="fixed inset-0 pointer-events-none z-50 hidden"></canvas>
    <!-- èƒŒæ™¯éŸ³æ¨‚ -->
    <audio id="bgm" src="start.mp3" loop></audio>
    <audio id="gift-sound" src="opengift.mp3"></audio> <!-- æ–°å¢ç¦®ç‰©éŸ³æ•ˆ -->
    <button id="music-btn" onclick="toggleMusic()" class="fixed top-4 right-4 z-50 text-2xl bg-black/30 w-10 h-10 rounded-full border border-white/20 flex items-center justify-center opacity-50 hover:opacity-100 transition">
        ğŸ”‡
    </button>
    
    <header class="text-center py-4 mb-2 z-10">
        <div class="w-40 h-40 mx-auto mb-2 rounded-full overflow-hidden border-4 border-yellow-400 shadow-lg relative bg-black/20">
            <img src="icon.jpg" alt="éº‹é¹¿ç¸" class="w-full h-full object-cover object-top">
        </div>
        <h1 class="text-4xl font-bold text-yellow-300 drop-shadow-md tracking-wider">ğŸ¦Œ è–èª•åŠ« ğŸ„</h1>
    </header>

    <div id="view-setup" class="flex-1 fade-in z-20 overflow-y-auto">
        <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 shadow-xl border border-white/20">
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <span>ğŸ›¡ï¸ è‹±é›„åå–®</span>
                <span id="count-display" class="ml-auto text-sm bg-red-600 px-2 py-1 rounded-full">15äºº</span>
            </h2>
            
            <div id="participants-list" class="space-y-2 max-h-60 overflow-y-auto mb-4 pr-1">
            </div>

            <div class="flex gap-2 mb-2">
                <input type="text" id="new-name" placeholder="è¼¸å…¥æ–°è‹±é›„" class="flex-1 bg-white/20 border border-white/30 rounded px-3 py-2 text-white placeholder-gray-300 focus:outline-none focus:border-yellow-400">
                <button id="gender-toggle" onclick="toggleGender()" class="w-12 bg-blue-600 rounded text-xl flex items-center justify-center">ğŸš¹</button>
            </div>
            <button onclick="addParticipant()" class="w-full bg-green-600 hover:bg-green-500 py-2 rounded font-bold shadow mb-6">ï¼‹ æ–°å¢</button>

            <div class="border-t border-white/20 pt-4 mb-6">
                <h3 class="text-lg font-bold mb-2 text-pink-300">â¤ï¸ ç¦å¿Œä¹‹æˆ€ â¤ï¸</h3>
                <div class="flex gap-2">
                    <input type="text" id="couple-1" value="ç´«ç’‡" class="w-1/2 bg-pink-900/40 border border-pink-500/50 rounded px-3 py-2 text-center">
                    <span class="py-2 text-pink-400">âš¡</span>
                    <input type="text" id="couple-2" value="æ™ºå ¯" class="w-1/2 bg-pink-900/40 border border-pink-500/50 rounded px-3 py-2 text-center">
                </div>
            </div>

            <button onclick="startStory()" class="w-full bg-gradient-to-r from-yellow-500 to-red-600 py-4 rounded-xl text-xl font-bold shadow-lg transform active:scale-95 transition-all">
                âš”ï¸ é–‹å§‹å†’éšª
            </button>
            
            <div class="mt-4 text-center">
                 <button onclick="resetData()" class="text-xs text-gray-400 underline">æ¸…é™¤ç´€éŒ„é‡ç½®</button>
            </div>
        </div>
    </div>

    <div id="view-story" class="hidden flex-1 flex flex-col justify-center items-center text-center fade-in p-4 z-20">
        <div class="bg-black/60 p-6 rounded-xl border border-red-500/50 shadow-2xl backdrop-blur w-full max-w-sm">
            <div class="w-full aspect-[3/4] mx-auto mb-4 rounded-xl overflow-hidden border-4 border-red-500 shadow-lg">
                <img src="monster_story.jpg" class="w-full h-full object-cover object-top animate-pulse">
            </div>
            <h2 class="text-2xl font-bold text-red-400 mb-4">âš ï¸ è­¦å ±ï¼šç½é›£é™è‡¨</h2>
            <p class="text-lg leading-relaxed mb-6 text-gray-100 text-center">
                é£¢é¤“å·²ä¹…çš„<b>éº‹é¹¿ç¸</b>ç”¦é†’äº†...<br>
                é€™ <span id="story-count" class="text-yellow-400 font-bold">15</span> ä½è‹±é›„å€‘æ˜¯å¦èƒ½å¤ ç¶­æŒå’Œå¹³å‘¢ï¼Ÿ<br>
                é‚„æ˜¯æœƒæˆç‚ºç‰ çš„è–èª•å¤§é¤ï¼Ÿ<br><br>
                å‘½é‹çš„è½‰ç›¤å·²ç¶“é–‹å§‹è½‰å‹•...
            </p>
            <button onclick="enterDraw()" class="bg-red-600 hover:bg-red-500 text-white px-10 py-3 rounded-full font-bold text-xl animate-bounce shadow-lg ring-4 ring-red-900">
                é€²å…¥æˆ°å ´
            </button>
            <div class="mt-4">
            </div>
        </div>
    </div>

    <div id="view-drawing" class="hidden flex-1 flex flex-col fade-in z-20 h-full">
        <!-- é ‚éƒ¨è³‡è¨Šåˆ— (æŠ½ç±¤æ™‚é¡¯ç¤ºï¼Œçµæœæ™‚éš±è—) -->
        <div id="drawing-header" class="text-center mb-2 flex justify-between items-center px-4">
            <div class="bg-blue-900/80 px-3 py-1 rounded-full text-xs border border-blue-400">
                Round <span id="round-number">1</span>
            </div>
            <h2 class="text-lg font-bold">
                é€ åŠ«è€…ï¼š<span id="current-giver" class="text-yellow-300">è‹±é›„A</span>
                <button onclick="debugSkipToFinale()" class="ml-2 text-sm opacity-20 hover:opacity-100" title="è·³é—œ">â­ï¸</button>
            </h2>
        </div>

        <div id="gift-box-area" class="flex-1 flex flex-col items-center justify-center cursor-pointer pb-20" onclick="revealReceiver()">
            <div class="text-9xl animate-bounce drop-shadow-[0_10px_10px_rgba(0,0,0,0.5)]">ğŸ</div>
            <p class="mt-8 text-2xl animate-pulse text-yellow-200 font-bold">é»æ“Šé–‹å•Ÿç¦®ç‰©</p>
        </div>

        <div id="reveal-area" class="hidden flex-1 flex flex-col items-center justify-center pb-10">
            <p class="text-gray-300 text-lg font-bold mb-2">æ¸¡åŠ«è€…æ˜¯...</p>
            <div class="text-3xl font-bold text-green-400 mb-4 drop-shadow-lg" id="current-receiver">
                è‹±é›„B
            </div>
            
            <div class="w-full bg-white/10 backdrop-blur rounded-xl p-6 border border-white/20">
                <p class="text-center mb-4 text-lg font-bold">è‹±é›„æ˜¯å¦æ»¿æ„ï¼Ÿ</p>
                <div class="grid grid-cols-2 gap-4 h-32">
                    <button onclick="handleFeedback(true)" class="bg-gradient-to-br from-emerald-600 to-green-800 hover:from-emerald-500 hover:to-green-700 text-white py-4 px-2 rounded-xl font-bold flex flex-col items-center justify-center gap-2 transform active:scale-95 transition shadow-[0_4px_0_rgb(6,78,59),0_10px_15px_-3px_rgba(0,0,0,0.3)] border border-emerald-400/30 h-full">
                        <span class="text-3xl filter drop-shadow">ğŸ„</span>
                        <span id="satisfied-text" class="text-sm text-center leading-tight drop-shadow-md">æ»¿æ„</span>
                    </button>
                    <button onclick="handleFeedback(false)" class="bg-gradient-to-br from-red-700 to-rose-900 hover:from-red-600 hover:to-rose-800 text-white py-4 px-2 rounded-xl font-bold flex flex-col items-center justify-center gap-2 transform active:scale-95 transition shadow-[0_4px_0_rgb(136,19,55),0_10px_15px_-3px_rgba(0,0,0,0.3)] border border-rose-400/30 h-full">
                        <span class="text-3xl filter drop-shadow">ğŸ…</span>
                        <span id="dissatisfied-text" class="text-sm text-center leading-tight drop-shadow-md">ä¸æ»¿æ„</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="battle-result-area" class="hidden flex-1 flex flex-col justify-start py-4 relative">
            
            <!-- é€ åŠ«è€…èˆ‡æ¸¡åŠ«è€…è³‡è¨Šåˆ— (æ–°å¢) -->
            <div id="role-info-bar" class="w-full flex justify-between items-center px-4 mb-2 z-30">
                <div class="bg-red-900/80 border border-red-500/50 px-3 py-1 rounded-full text-sm text-red-100 shadow-lg">
                    é€ åŠ«è€…ï¼š<span id="result-giver" class="font-bold text-yellow-300">è‹±é›„A</span>
                </div>
                <div class="bg-green-900/80 border border-green-500/50 px-3 py-1 rounded-full text-sm text-green-100 shadow-lg">
                    æ¸¡åŠ«è€…ï¼š<span id="result-receiver" class="font-bold text-yellow-300">è‹±é›„B</span>
                </div>
            </div>

            <!-- åŠ‡æƒ…æ–‡å­—å€ (å­—é«”ç¸®å° text-lg) -->
            <div class="px-6 py-1 z-30 w-full mb-2"> 
                <div class="bg-black/70 backdrop-blur border border-yellow-500/50 rounded-lg p-3 text-center min-h-[60px] flex items-center justify-center w-full mx-auto shadow-lg">
                    <p id="battle-text" class="text-lg font-bold text-white leading-relaxed"></p>
                </div>
            </div>

            <div class="flex-1 flex items-center justify-center relative z-20 w-full min-h-0 overflow-hidden px-4 pb-16">
                <div class="w-full h-full relative flex items-center justify-center max-w-4xl mx-auto">
                    <!-- åœ–ç‰‡æ¨¡å¼ (é è¨­éš±è—ï¼Œå½±ç‰‡æ’­æ”¾å¤±æ•—æ™‚å‚™ç”¨æˆ–èˆŠæœ‰é‚è¼¯) -->
                    <img src="icon.jpg" id="monster-img" class="hidden w-40 h-40 rounded-full object-cover object-top border-4 border-red-500 shadow-[0_0_30px_rgba(255,0,0,0.5)] z-10 relative transition-transform">
                    
                    <!-- å½±ç‰‡æ’­æ”¾å€ (ç¸®å°é¡¯ç¤º) -->
                    <video id="battle-video" class="w-full h-full object-contain rounded-xl z-30 max-h-[60vh]" playsinline webkit-playsinline></video>
                    
                    <div id="effect-overlay" class="absolute inset-0 flex items-center justify-center text-9xl z-50 pointer-events-none opacity-0">ğŸ’¥</div>
                </div>
            </div>

            <div id="hero-display-area" class="flex-1 flex flex-col items-center justify-end pb-4 relative">
                <div class="w-40 h-40 mb-2 relative group z-20">
                    <img id="hero-img" src="" class="w-full h-full object-cover object-top rounded-xl border-2 border-white/50 shadow-2xl hero-idle">
                    <div id="hero-damage-overlay" class="absolute inset-0 bg-red-600 mix-blend-overlay opacity-0 rounded-xl"></div>
                </div>
                
                <h3 id="battle-hero-name" class="text-2xl font-bold text-yellow-300 drop-shadow-md bg-black/30 px-4 py-1 rounded-full z-20">
                    è‹±é›„å
                </h3>
            </div>

            <div class="absolute bottom-4 left-4 z-50">
                <button onclick="document.getElementById('battle-video').currentTime = 0; document.getElementById('battle-video').play();" class="bg-gray-700 hover:bg-gray-600 text-white font-bold px-4 py-3 rounded-full shadow-xl border border-gray-500">
                     â†º å†çœ‹ä¸€æ¬¡
                </button>
            </div>

            <div class="absolute bottom-4 right-4 z-50">
                <button id="next-round-btn" onclick="nextRound()" class="bg-yellow-500 hover:bg-yellow-400 text-black font-bold px-6 py-3 rounded-full shadow-xl animate-bounce">
                    ä¸‹ä¸€ä½ âœ
                </button>
            </div>
        </div>
    </div>

    <div id="view-grand-finale" class="hidden flex-1 flex flex-col items-center justify-center fade-in z-20 pb-10">
        <!-- <h2 class="text-4xl font-bold text-yellow-300 mb-6 drop-shadow-lg glitch-text">ğŸ† æˆ°å½¹æœ€çµ‚çµæœ ğŸ†</h2> (å·²éš±è—) -->
        
        <div class="flex items-center gap-8 mb-6 text-2xl font-bold bg-black/40 p-4 rounded-xl border border-white/20">
            <div class="text-center">
                <span class="block text-sm text-yellow-500 mb-1">HEROES</span>
                <span id="final-score-hero" class="text-4xl text-green-400">0</span>
            </div>
            <span class="text-3xl text-gray-400">VS</span>
            <div class="text-center">
                <span class="block text-sm text-red-500 mb-1">MONSTER</span>
                <span id="final-score-monster" class="text-4xl text-red-400">0</span>
            </div>
        </div>

        <div class="w-full max-w-4xl h-[60vh] relative flex items-center justify-center mb-8">
            <video id="final-video" class="w-full h-full object-contain rounded-xl" playsinline webkit-playsinline></video>
        </div>

        <button onclick="showResultsList()" class="bg-gradient-to-r from-yellow-600 to-amber-700 hover:from-yellow-500 hover:to-amber-600 text-white font-bold py-2 px-6 rounded-full text-base shadow-lg transition-transform hover:scale-105 border border-yellow-500/30 animate-pulse-gentle">
            ğŸ“Š è§€çœ‹æˆ°å½¹ç´€éŒ„
        </button>
    </div>

    <div id="view-result" class="hidden flex-1 fade-in z-20 pb-10">
        <h2 class="text-2xl font-bold text-center mb-6 text-yellow-300">ğŸ“œ æˆ°å½¹ç´€éŒ„ ğŸ“œ</h2>
        
        <div class="bg-white/90 text-gray-900 rounded-xl shadow-2xl overflow-hidden mb-4">
            <div class="max-h-[60vh] overflow-y-auto" id="final-list">
            </div>
        </div>

        <div class="flex flex-col items-center justify-center gap-3">
            <button onclick="resetData()" class="w-full max-w-xs bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 rounded-lg shadow-lg text-center transform transition hover:scale-105">
                ğŸ”„ å†æˆ°ä¸€å±€
            </button>
        </div>
    </div>

    <div id="reset-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm fade-in">
        <div class="bg-white/10 border border-white/20 p-6 rounded-xl shadow-2xl max-w-xs w-full text-center">
            <h3 class="text-xl font-bold text-yellow-300 mb-4">âš ï¸ è­¦å‘Š</h3>
            <p class="text-white mb-6">ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç´€éŒ„ä¸¦é‡æ–°é–‹å§‹å—ï¼Ÿ<br>æ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚</p>
            <div class="flex gap-4">
                <button onclick="closeResetModal()" class="flex-1 py-2 rounded-lg bg-gray-600 hover:bg-gray-500 text-white font-bold">å–æ¶ˆ</button>
                <button onclick="confirmReset()" class="flex-1 py-2 rounded-lg bg-red-600 hover:bg-red-500 text-white font-bold shadow-lg shadow-red-900/50">ç¢ºèªæ¸…é™¤</button>
            </div>
        </div>
    </div>

    <div id="instruction-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm fade-in">
        <div class="bg-gray-900 border border-yellow-500/50 p-6 rounded-xl shadow-2xl max-w-sm w-full text-center relative">
            <h3 class="text-xl font-bold text-yellow-300 mb-4">ğŸ“œ é€ åŠ«è¦å‰‡èªªæ˜</h3>
            <p class="text-white mb-6 text-left leading-relaxed text-sm">
                ç•¶<span class="text-green-400 font-bold">æ¸¡åŠ«è€…</span>ã€Œæ»¿æ„ã€<span class="text-red-400 font-bold">é€ åŠ«è€…</span>çµ¦çš„ç½é›£æ™‚ï¼Œé€ åŠ«è€…å°‡æˆåŠŸæ“Šæ•—éº‹é¹¿ç¸ï¼<br><br>
                è‹¥ã€Œä¸æ»¿æ„ã€ï¼Œé€ åŠ«è€…å°‡æœƒè¢«éº‹é¹¿ç¸åæ“Š...<br><br>
                (æ­¤è¨Šæ¯åªæœƒå‡ºç¾ä¸€æ¬¡)
            </p>
            <button onclick="closeInstructionModal()" class="w-full py-3 rounded-lg bg-yellow-500 hover:bg-yellow-400 text-black font-bold shadow-lg shadow-yellow-500/20">
                äº†è§£ï¼Œé–‹å§‹æŒ‘æˆ°ï¼
            </button>
        </div>
    </div>
    
    <script>
    function debugSkipToFinale() {
        if (battleHistory.length >= participants.length - 1) return;
        
        // è£œé½Šå‰é¢çš„ç´€éŒ„ (æ¨¡æ“¬)
        const targetIndex = participants.length - 1;
        for (let i = currentIndex; i < targetIndex; i++) {
            const giver = drawOrder[i];
            const receiver = drawOrder[(i + 1) % drawOrder.length];
            const isSatisfied = Math.random() > 0.5;
            const scenario = isSatisfied 
                ? { emoji: 'ğŸï¸', text: 'å¿«é€Ÿé€šé—œç”Ÿæˆçš„å‹åˆ©ï¼' } 
                : { emoji: 'ğŸ›Œ', text: 'å¿«é€Ÿé€šé—œç”Ÿæˆçš„å¤±æ•—...' };
            
            battleHistory.push({ giver, receiver, isSatisfied, scenario });
        }
        
        currentIndex = targetIndex;
        setupRound();
    }
    </script>

</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    // éŸ³æ¨‚æ§åˆ¶
    // éŸ³æ¨‚æ§åˆ¶
    const bgm = document.getElementById('bgm');
    let isMusicPlaying = false;
    // åˆå§‹åŒ–æ™‚è®€å–ä½¿ç”¨è€…åå¥½ï¼Œé è¨­ç‚ºé–‹å•Ÿ (false)
    let userMuted = localStorage.getItem('xmasUserMuted') === 'true';

    // å¦‚æœä½¿ç”¨è€…è¨­å®šéœéŸ³ï¼Œåˆå§‹åŒ–æ™‚å°±åŠ ä¸Š muted å±¬æ€§ (é›–ç„¶ bgm ç”¨ js æ§åˆ¶ï¼Œä½†ä¿æŒä¸€è‡´å¥½)
    if (userMuted) bgm.muted = true;
    updateMusicBtn(); // åˆå§‹åŒ–æŒ‰éˆ•ç‹€æ…‹

    function playBGM() {
        if (userMuted) return; // å¦‚æœä½¿ç”¨è€…æ‰‹å‹•éœéŸ³ï¼Œå°±ä¸è‡ªå‹•æ’­æ”¾

        if (!isMusicPlaying) {
            bgm.play().then(() => {
                isMusicPlaying = true;
                updateMusicBtn();
            }).catch(e => console.log("ç­‰å¾…ä½¿ç”¨è€…äº’å‹•ä»¥æ’­æ”¾éŸ³æ¨‚"));
        } else if (bgm.paused) {
             // å¦‚æœç‹€æ…‹æ˜¯ playing ä½†å¯¦éš›æš«åœ (ä¾‹å¦‚åˆ‡æ› src å¾Œ)
             bgm.play().then(() => updateMusicBtn());
        }
    }

    function toggleMusic() {
        if (bgm.paused || bgm.muted) {
            // é–‹å•ŸéŸ³æ¨‚
            bgm.muted = false;
            userMuted = false;
            localStorage.setItem('xmasUserMuted', 'false');
            bgm.play();
            isMusicPlaying = true;
        } else {
            // é—œé–‰éŸ³æ¨‚
            bgm.pause();
            userMuted = true;
            localStorage.setItem('xmasUserMuted', 'true');
            isMusicPlaying = false;
        }
        updateMusicBtn();
    }

    function updateMusicBtn() {
        const btn = document.getElementById('music-btn');
        btn.classList.remove('hidden'); 
        // ä¾æ“š userMuted é¡¯ç¤ºç‹€æ…‹
        btn.innerText = userMuted ? 'ğŸ”‡' : 'ğŸ”Š';
        // åªæœ‰åœ¨æ’­æ”¾ä¸”æ²’éœéŸ³æ™‚æ‰è·³å‹•
        const isActuallyPlaying = !bgm.paused && !userMuted;
        btn.classList.toggle('animate-pulse', isActuallyPlaying);
    }
    

    function playSound(type) {
        if (userMuted) return; // éµå®ˆéœéŸ³è¨­å®š
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        if (type === 'attack') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(50, now + 0.5); gainNode.gain.setValueAtTime(0.2, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.5); osc.start(now); osc.stop(now + 0.5); } 
        else if (type === 'hit') { osc.type = 'square'; osc.frequency.setValueAtTime(150, now); osc.frequency.exponentialRampToValueAtTime(0.01, now + 0.3); gainNode.gain.setValueAtTime(0.5, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3); osc.start(now); osc.stop(now + 0.3); } 
        else if (type === 'sword') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(600, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.1); gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.1); osc.start(now); osc.stop(now + 0.1); } 
        else if (type === 'win') { osc.type = 'triangle'; osc.frequency.setValueAtTime(440, now); osc.frequency.setValueAtTime(554, now + 0.1); osc.frequency.setValueAtTime(659, now + 0.2); gainNode.gain.setValueAtTime(0.2, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.6); osc.start(now); osc.stop(now + 0.6); }
    }
</script>

<script>
    // --- 1. è³‡æ–™è¨­å®š (V3.0 å¤©æ¢æ–‡æ¡ˆ) ---
    
    // ç”Ÿæ°£åœ–æ¸…å–® (éš¨æ©ŸæŠ½)
    const angryImages = [
        "reindeer_heroes_running.jpg",
        "reindeer_heroes_presents.jpg",
        "reindeer_heroes_battle.jpg",
        "reindeer_heroes_magic_battle.jpg"
    ];

    // æˆ°æ•—åœ–æ¸…å–® (éš¨æ©ŸæŠ½)
    const deadImages = [
        "monster_dead_crowd.jpg",
        "monster_dead_scarf_full.jpg",
        "monster_dead_scarf_simple.jpg",
        "monster_dead_scarf_close.jpg", 
        "monster_dead_broken.jpg"        
    ];

    // è‹±é›„å¿…æ®ºæŠ€åå–®
    const heroAttacks = {
        'æ™ºå ¯': 'ç”¨ç­†é›»å¯«å‡ºçš„ç„¡çª®è¿´åœˆç¨‹å¼ç¢¼ï¼Œè®“å…‡çŒ›ç‹‚æš´çš„è–èª•éº‹é¹¿ç¸å¤§è…¦ç›´æ¥ç•¶æ©Ÿï¼',
        'å† å®‡': 'åˆ©ç”¨ç™»å±±é‹å™´å°„ä¸Šç©ºå¾Œå‘ä¸‹ä¿¯è¡ï¼Œç”¨å°–è‹¥ç£çŸ³çš„ç™»å±±æ–æ‰“æ‰éº‹é¹¿ç¸çš„é¹¿è§’ï¼',
        'æ™¨è±ª': 'å¸¶é ˜æ³°åœ‹ç¾å¥³è»åœ˜ï¼Œä½¿ç”¨ã€Œè–©ç“¦è¿ªå¡å…‰æ³¢ã€é–ƒçéº‹é¹¿ç¸ï¼',
        'å£«å®¶': 'é›†çµå…¨å®¶äººçš„æ„›ï¼Œæ´¾å‡ºã€Œè¶…äººç™½è²“ã€ä½¿å‡ºç˜‹ç‹‚äº‚æŠ“ï¼Œéº‹é¹¿ç¸ç—›å¾—å—·å—·å«ï¼',
        'éŠ˜ç‘‹': 'æ¨äº†ä¸€ä¸‹çœ¼é¡ï¼Œç”¨ã€Œå¯Œå£«å±±æ€¥å‡å…‰æ³¢ã€æŠŠéº‹é¹¿ç¸è®Šæˆå†°æ£’ï¼',
        'ä½³ç‘œ': 'æŸ¯åŸºçŠ¬ä½¿å‡ºã€Œé£›å¤©å…‡çŒ›å’¬å’¬æ”»æ“Šã€ï¼Œç²¾æº–å’¬ä½éº‹é¹¿ç¸çš„è…³è¸ï¼',
        'å¿µæ…ˆ': 'åœ¨ç•°åœ‹å¸‚é›†ä¸­æ–½å±•å¹»è¡“ï¼Œæ´¾ã€Œè³“å£«è²“åˆºå®¢ã€å·èµ°éº‹é¹¿ç¸çš„ä¾¿ç•¶ï¼',
        'è‚²å§': 'ç”¨æ¼”å”±æœƒç­‰ç´šçš„æ‡‰æ´å¼å«è²ï¼ŒæŠŠéº‹é¹¿ç¸éœ‡é£›åˆ°å¤–å¤ªç©ºï¼',
        'è‹±ç­‘': 'å¬å–šã€Œé•·è…¿æ­å·´è­·è¡›éšŠã€ï¼Œæ–½å±•å¥½å¸¥å¥½å¸¥æ”»æ“Šï¼Œè®“éº‹é¹¿ç¸æ‹›æ¶ä¸ä½ï¼',
        'æƒ å­': 'å¬å–šæ¥µåœˆã€Œæ­è‹¥æ‹‰ä¹‹å…‰ã€ï¼Œçµ¢éº—æ¥µå…‰è®“éº‹é¹¿ç¸æšˆé ­è½‰å‘ï¼Œå·®é»æ’ä¸Šæ¨¹ï¼',
        'ç´«ç’‡': 'èˆ‡ç‹—ç‹—è¶…äººå¬å–šé­”å¹»èˆå°ï¼Œå°‡å…‡çŒ›éº‹é¹¿ç¸ç”©å›æ£®æ—ï¼',
        'æŸèŒµ': 'èˆ‡å‰ç¥¥ç‰©å€‘ç”¨é–ƒäº®æ­Œè²é–‹å§‹ç¾å ´æ¼”å”±ï¼Œéº‹é¹¿ç¸è½å¾—é ­æ˜è…¦è„¹ã€å£åç™½æ²«ï¼',
        'æ•æ¯“': 'ç©¿æ¢­éƒ½å¸‚å¤§æ¨“é–“ï¼Œç”¨ã€Œç«ç„°æŠ«é¢¨è¿´æ—‹ã€æŠŠéº‹é¹¿ç¸çƒ¤æˆäº†äºŒåˆ†ç†Ÿï¼',
        'äº­æ½”': 'åœ¨æ«»èŠ±é›¨ä¸­æŒ‡æ´¾ã€Œç°è²“è¶…äººã€æ–½å±•è²“è²“é€£ç’°æ”»æ“Šï¼Œéº‹é¹¿ç¸å·²ç¶“æšˆé ­è½‰å‘ï¼',
        'è© ç­‘': 'æŒ‡æ®èº«å¾Œã€ŒèŒå¯µå¤§è»ã€æ’²å‘å‰æ–¹ï¼Œéº‹é¹¿ç¸å¿«è¢«èåŒ–ï¼Œè®ŠæˆèŒèŒå°é¹¿ï¼'
    };

    // è‹±é›„æˆ°æ•—åå–® (ä¸æ»¿æ„)
    const heroDefeats = {
        'æ™ºå ¯': 'æ™ºå ¯ç”¨ç­†é›»å¯«å‡ºçš„ç„¡çª®è¿´åœˆç¨‹å¼ç¢¼æ”»æ“Šå¤±æ•—ï¼Œéº‹é¹¿ç¸æ´¾å‡ºè–èª•ç•ªèŒ„å¤§è»ï¼Œæ™ºå ¯å®³æ€•æ¥µäº†',
        'å† å®‡': 'ä¿¯è¡æ“Šè½ç¬é–“ï¼Œéº‹é¹¿ç¸ç”©å°¾æ€èµ·æš´é›ªäº‚æµï¼Œç™»å±±æ–è¢«éœ‡é£›ï¼Œå† å®‡æ»¾è½å±‹é ‚é‚Šç·£ï¼Œåªèƒ½æš«é€€æ•´è£ã€‚',
        'æ™¨è±ª': 'å…‰æ³¢å‰›èšï¼Œéº‹é¹¿ç¸ä»¥ã€Œæ¥µå¤œé®è”½ã€åå™¬å…‰æŸï¼Œåå°„å‡ºåˆºçœ¼é»‘å…‰ï¼Œæ™¨è±ªèˆ‡è»åœ˜è¢«è¿«æ’¤é›¢ã€‚',
        'å£«å®¶': 'ç™½è²“é€£æŠ“è¢«ã€Œå†°éœœé¹¿è¹„ã€å®šèº«ï¼Œå£«å®¶æ€¥å¿™å°‡è²“æŠ±èµ·ä¾†èˆ‡å®¶äººæ’¤é›¢ã€‚',
        'éŠ˜ç‘‹': 'å†°éœ§å‰›æˆå½¢å°±è¢«éº‹é¹¿ç¸èè§£ï¼Œåè½‰æˆç†±æµªï¼ŒéŠ˜ç‘‹çœ¼é¡èµ·éœ§çœ‹ä¸æ¸…ï¼Œè¢«è¿«é€€åˆ°å··å£ã€‚',
        'ä½³ç‘œ': 'æŸ¯åŸºé£›æ’²æ™‚é­éº‹é¹¿ç¸ç”¨é¹¿è§’é ‚èµ°ï¼Œä½³ç‘œåš‡çˆ›ï¼Œè¿…é€Ÿå°‡æŸ¯åŸºæŠ±å›ä¾†ï¼Œéº‹é¹¿ç¸ç«™èµ·ä¾†æœå¤©å¤§ç¬‘',
        'å¿µæ…ˆ': 'å¿µæ…ˆçš„ã€Œè¶…äººè³“å£«è²“ã€æ‹¿è‘—ä¸€æŠŠéº‹é¹¿æ„›åƒçš„æ£‰èŠ±è‰è©¦åœ–è³„è³‚ï¼Œå’¬äº†ä¸€å£ç™¼ç¾å¤ªé›£åƒï¼Œå‚»çœ¼å€’é€€åš•ï¼',
        'è‚²å§': 'å¼è²å‰›èµ·è¢«éº‹é¹¿ç¸ä»¥ã€Œæ¥µä½é »é¹¿é³´ã€å°æ¶ˆï¼ŒéŸ³ç‰†å´©å¡Œå›å½ˆï¼Œè‚²å§è¢«éœ‡å¾—å¾Œé€€ï¼Œæ‡‰æ´ç‡ˆç‰Œç†„æ»…åˆå¿½äº®ã€‚',
        'è‹±ç­‘': 'è‹±ç­‘èº«å¾Œçš„æ­å·´è­·è¡›éšŠåŸæœ¬æƒ³å¸¥æ°£è­·ä¸»ï¼Œçµæœè¢«éº‹é¹¿ç¸ä¸€è¨˜ã€åƒå¹´é™³é‡€å£è‡­ã€æ­£é¢å™´å°„ï¼Œé¡å€¼å†é«˜ä¹Ÿæ“‹ä¸ä½ç”ŸåŒ–æ”»æ“Šï¼Œå…¨å“¡ç¬é–“æšˆå€’ï¼',
        'æƒ å­': 'æƒ å­çš„ã€Œæ­è‹¥æ‹‰ä¹‹å…‰ã€æ”»æ“Šè¢«éº‹é¹¿ç¸å¼•ä¾†çš„ã€Œæ¥µåœˆé¢¨æš´çœ¼ã€åæ²’ï¼Œè‰²å¸¶æ–·è£‚åŒ–ç‚ºæµçŸ¢åæ’²ï¼Œæƒ å­è¢«é¢¨å¹å¾—æ­¥ä¼å‡Œäº‚ã€‚',
        'ç´«ç’‡': 'å·¨å¤§è–èª•éº‹é¹¿æ‹›å–šçˆ¬èŸ²å¤§è»ï¼Œç´«ç’‡è·Ÿç‹—ç‹—è¶…äººå¿«åš‡æ­»äº†',
        'æŸèŒµ': 'éº‹é¹¿é­”éŸ³ç©¿è…¦çš„æ­Œè²ï¼Œè®“æŸèŒµå—ä¸äº†ï¼Œæ†¤è€Œé›¢å ´',
        'æ•æ¯“': 'ç«æ—‹è¢«éº‹é¹¿ç¸ä»¥ã€Œæ¥µåœ°å†·å‡ã€ç¬é–“é™æº«ï¼ŒåŒ–ä½œç¢å†°åˆ€é›¨åè¡ï¼Œæ•æ¯“ä»¥æŠ«é¢¨è­·é«”ï¼Œæ‹–å‡ºé•·é•·åŠƒç—•æ’¤é›¢ã€‚',
        'äº­æ½”': 'è²“è²“é€£ç’°è¢«éº‹é¹¿ç¸ä»¥ã€Œè½æ«»äº‚æµã€åæ“¾ï¼ŒèŠ±é›¨å¿½è½‰ç‚ºå†°æ™¶ï¼Œç°è²“è¸©ç©ºæ»‘è¡Œï¼Œäº­æ½”è¶•ç·Šæ¥ä½ç°è²“æ’¤åˆ°æ«»æ¨¹ä¸‹ã€‚',
        'è© ç­‘': 'è–èª•éº‹é¹¿å¯¶å¯¶å¤ªå¯æ„›äº†ï¼Œå¤§å®¶å¿˜è¨˜æ”»æ“Šï¼Œçœ¼ç›å……æ»¿æ„›å¿ƒï¼Œå¿«è¦èåŒ–äº†'
    };

    // é è¨­åå–®
    const defaultParticipants = [
        'æ™¨è±ª', 'ä½³ç‘œ', 'å¿µæ…ˆ', 'è© ç­‘', 'æƒ å­', 
        'äº­æ½”', 'å£«å®¶', 'å† å®‡', 'æ•æ¯“', 'æŸèŒµ', 
        'è‹±ç­‘', 'ç´«ç’‡', 'æ™ºå ¯', 'éŠ˜ç‘‹', 'è‚²å§'
    ];
    
    // æ€§åˆ¥è³‡æ–™ (æ³¨æ„ï¼šè© ç­‘è¨­ç‚ºF)
    const genderData = {
        'æ™¨è±ª': 'M', 'ä½³ç‘œ': 'F', 'å¿µæ…ˆ': 'F', 'è© ç­‘': 'F', 'æƒ å­': 'F',
        'äº­æ½”': 'F', 'å£«å®¶': 'M', 'å† å®‡': 'M', 'æ•æ¯“': 'F', 'æŸèŒµ': 'F',
        'è‹±ç­‘': 'F', 'ç´«ç’‡': 'F', 'æ™ºå ¯': 'M', 'éŠ˜ç‘‹': 'M', 'è‚²å§': 'F'
    };

    // --- è‹±é›„ç…§ç‰‡å°æ‡‰ ---
    const maleGroupMap = {
        'æ™ºå ¯': 'boy_a.jpg', 
        'å† å®‡': 'boy_b.jpg', 
        'æ™¨è±ª': 'boy_c.jpg', 
        'å£«å®¶': 'boy_d.jpg',
        'éŠ˜ç‘‹': 'boy_e.jpg'
    };

    const femaleGroupMap = {
        'ä½³ç‘œ': 'girl_a.jpg',
        'å¿µæ…ˆ': 'girl_b.jpg', 
        'è‚²å§': 'girl_c.jpg',
        'è‹±ç­‘': 'girl_d.jpg',
        'æƒ å­': 'girl_e.jpg',
        'ç´«ç’‡': 'girl_f.jpg',
        'æŸèŒµ': 'girl_g.jpg',
        'æ•æ¯“': 'girl_h.jpg',
        'äº­æ½”': 'girl_i.jpg',
        'è© ç­‘': 'girl_j.jpg'
    };

    let participants = [...defaultParticipants];
    let couple = { p1: 'ç´«ç’‡', p2: 'æ™ºå ¯' };
    let drawOrder = [];
    let currentIndex = 0;
    let battleHistory = [];
    let tempNewGender = 'M';

    const victoryScenarios = [
        { emoji: 'âš”ï¸', text: 'ä¸€åŠæ–¬æ–·äº†éº‹é¹¿ç¸çš„é¹¿è§’ï¼' },
        { emoji: 'ğŸ”¥', text: 'è–èª•ç«ç„°å°‡éº‹é¹¿ç¸çƒ¤æˆäº†ç‰›æ’ï¼' },
        { emoji: 'â„ï¸', text: 'å†°é›ªé­”æ³•æŠŠéº‹é¹¿ç¸å‡æˆäº†å†°é›•ï¼' },
        { emoji: 'ğŸ‘Š', text: 'ä¸€è¨˜ä¸Šå‹¾æ‹³æŠŠéº‹é¹¿ç¸æ‰“é£›åˆ°æœˆçƒï¼' },
        { emoji: 'ğŸ…', text: 'å¬å–šè–èª•è€äººæŠŠéº‹é¹¿ç¸æŠ“å›å»åŠ ç­ï¼' }
    ];

    const defeatScenarios = [
        { emoji: 'ğŸ˜±', text: 'é‚„æ²’åæ‡‰éä¾†å°±è¢«ä¸€å£åæ‰äº†ï¼' },
        { emoji: 'ğŸ’¨', text: 'æƒ³é€ƒè·‘ä½†è¢«éº‹é¹¿ç¸ä¸€è…³è¸©æ‰ï¼' },
        { emoji: 'ğŸ˜µ', text: 'è¢«éº‹é¹¿ç¸çš„å‚¬çœ å…‰æ³¢è®Šæˆäº†é»å¿ƒï¼' },
        { emoji: 'ğŸ”¨', text: 'æ­¦å™¨æ–·è£‚ï¼Œè¢«éº‹é¹¿ç¸æ’é£›å‡ºåœ°çƒï¼' },
        { emoji: 'ğŸ–', text: 'è¢«ç•¶æˆè–èª•å¤§é¤åƒå¾—ä¹¾ä¹¾æ·¨æ·¨ï¼' }
    ];

    // --- 2. åˆå§‹åŒ– ---
    window.onload = function() {
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }
        loadData();
        renderParticipants();
        
        const savedState = localStorage.getItem('xmasState');
        if (savedState) {
            const state = JSON.parse(savedState);
            if (state.step === 'result') {
                showView('view-result');
                renderResults(state.battleHistory);
            } else if (state.step === 'finale') {
                // å¦‚æœæ˜¯åœ¨çµå±€ç•«é¢é‡æ•´
                participants = JSON.parse(localStorage.getItem('xmasParticipants')); // ç¢ºä¿æœ‰è¼‰å…¥åå–®é•·åº¦
                showView('view-grand-finale');
                showGrandFinale(); // å‰ç«¯æš«å­˜çš„ history å¯èƒ½æœƒç©ºï¼Œéœ€æ³¨æ„
                // é€™è£¡ç°¡åŒ–è™•ç†ï¼šè‹¥é‡æ•´å°è‡´ battleHistory ç‚ºç©ºï¼Œå¯èƒ½éœ€å¾ localStorage è®€å›
                if (state.battleHistory) battleHistory = state.battleHistory;
                showGrandFinale();
            }
        }
    };

    // --- 3. é‚è¼¯å‡½æ•¸ ---
    function loadData() {
        const savedPart = localStorage.getItem('xmasParticipants');
        if (savedPart) participants = JSON.parse(savedPart);
        const savedGender = localStorage.getItem('xmasGender');
        if (savedGender) Object.assign(genderData, JSON.parse(savedGender));
        const savedCouple = localStorage.getItem('xmasCouple');
        if (savedCouple) couple = JSON.parse(savedCouple);
        
        document.getElementById('couple-1').value = couple.p1;
        document.getElementById('couple-2').value = couple.p2;
        updateCount();
    }

    function renderParticipants() {
        const list = document.getElementById('participants-list');
        list.innerHTML = '';
        participants.forEach((p, index) => {
            const g = genderData[p] || 'M';
            const badge = g === 'M' ? 'bg-blue-600' : 'bg-pink-600';
            const icon = g === 'M' ? 'ğŸš¹' : 'ğŸšº';
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 bg-black/20 p-2 rounded hover:bg-black/30 transition';
            div.innerHTML = `
                <span class="w-6 text-center text-gray-400 font-mono">${index + 1}</span>
                <span class="${badge} text-xs px-1 rounded">${icon}</span>
                <span class="flex-1 font-bold tracking-wide">${p}</span>
                <button onclick="removeParticipant(${index})" class="text-red-400 hover:text-red-200 px-3 font-bold">âœ•</button>
            `;
            list.appendChild(div);
        });
        updateCount();
    }

    function toggleGender() {
        const btn = document.getElementById('gender-toggle');
        if (tempNewGender === 'M') {
            tempNewGender = 'F';
            btn.innerText = 'ğŸšº';
            btn.className = 'w-12 bg-pink-600 rounded text-xl flex items-center justify-center';
        } else {
            tempNewGender = 'M';
            btn.innerText = 'ğŸš¹';
            btn.className = 'w-12 bg-blue-600 rounded text-xl flex items-center justify-center';
        }
    }

    function addParticipant() {
        const input = document.getElementById('new-name');
        const name = input.value.trim();
        if (name) {
            participants.push(name);
            genderData[name] = tempNewGender;
            input.value = '';
            saveConfig();
            renderParticipants();
        }
    }

    function removeParticipant(index) {
        if (participants.length <= 3) return alert('äººæ•¸éå°‘');
        const name = participants[index];
        participants.splice(index, 1);
        delete genderData[name];
        saveConfig();
        renderParticipants();
    }

    function updateCount() {
        document.getElementById('count-display').innerText = `${participants.length}äºº`;
        document.getElementById('story-count').innerText = participants.length;
    }

    function saveConfig() {
        couple.p1 = document.getElementById('couple-1').value.trim();
        couple.p2 = document.getElementById('couple-2').value.trim();
        localStorage.setItem('xmasParticipants', JSON.stringify(participants));
        localStorage.setItem('xmasGender', JSON.stringify(genderData));
        localStorage.setItem('xmasCouple', JSON.stringify(couple));
    }

    function startStory() {
        saveConfig();
        if (participants.length < 3) return alert('äººæ•¸ä¸è¶³ï¼');
        if (!generateDrawOrder()) return alert('ç„¡æ³•ç”Ÿæˆæœ‰æ•ˆé †åº');
        showView('view-story');
        // åˆ‡æ›åˆ°æˆ°é¬¥éŸ³æ¨‚
        bgm.src = 'war.mp3';
        playBGM(); 
    }

    function generateDrawOrder() {
        const c1 = couple.p1;
        const c2 = couple.p2;
        let valid = false;
        let attempts = 0;
        let shuffled = [];
        while (!valid && attempts < 2000) {
            shuffled = [...participants];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            let isChainValid = true;
            for (let i = 0; i < shuffled.length; i++) {
                const giver = shuffled[i];
                const receiver = shuffled[(i + 1) % shuffled.length];
                if ((giver === c1 && receiver === c2) || (giver === c2 && receiver === c1)) {
                    isChainValid = false;
                    break;
                }
            }
            if (isChainValid) valid = true;
            attempts++;
        }
        if (valid) {
            drawOrder = shuffled;
            currentIndex = 0;
            battleHistory = [];
            return true;
        }
        return false;
    }

    function enterDraw() {
        showView('view-drawing');
        setupRound();
        // ç¢ºä¿æˆ°é¬¥éŸ³æ¨‚æ’­æ”¾ (å¦‚æœæ˜¯é‡æ•´å¾Œå›ä¾†ï¼Œå¯èƒ½éœ€è¦åˆ‡æ›)
        if (!bgm.src.includes('war.mp3')) {
            bgm.src = 'war.mp3';
        }
        playBGM(); 
    }

    function getHeroImage(name) {
        // å…ˆæª¢æŸ¥æ˜¯å¦æœ‰æŒ‡å®šå°æ‡‰åœ–
        if (maleGroupMap[name]) return maleGroupMap[name];
        if (femaleGroupMap[name]) return femaleGroupMap[name];

        // æ²’æœ‰æŒ‡å®šçš„è©±ï¼Œçµ¦é è¨­åœ–
        const gender = genderData[name] || 'M';
        if (gender === 'M') return 'boy_e.jpg'; 
        else return 'girl_a.jpg'; 
    }

    // --- åŠŸèƒ½ï¼šéš¨æ©ŸæŒ‘é¸ä¸€å¼µåœ–ç‰‡ ---
    function getRandomImage(type) {
        const list = type === 'angry' ? angryImages : deadImages;
        const randomIndex = Math.floor(Math.random() * list.length);
        return list[randomIndex];
    }

    function setupRound() {
        document.getElementById('gift-box-area').classList.remove('hidden');
        document.getElementById('reveal-area').classList.add('hidden');
        document.getElementById('battle-result-area').classList.add('hidden');
        
        document.getElementById('gift-box-area').classList.remove('hidden');
        document.getElementById('reveal-area').classList.add('hidden');
        document.getElementById('battle-result-area').classList.add('hidden');
        
        // æ¢å¾©èƒŒæ™¯éŸ³æ¨‚ (å¦‚æœè¢«æš«åœä¸”æ˜¯æˆ°é¬¥ç‹€æ…‹)
        if (!userMuted && bgm.paused && bgm.src.includes('war.mp3')) {
            bgm.play().then(() => updateMusicBtn()).catch(console.error);
        }
        
        const videoElement = document.getElementById('battle-video');
        videoElement.classList.add('hidden');
        document.getElementById('hero-display-area').classList.remove('hidden'); // æ¢å¾©é¡¯ç¤ºè‹±é›„å€
        videoElement.pause();
        videoElement.src = ""; // æ¸…ç©ºä¾†æº

        const monsterImg = document.getElementById('monster-img');
        const heroImg = document.getElementById('hero-img');
        const effectOverlay = document.getElementById('effect-overlay');
        
        monsterImg.src = 'icon.jpg'; 
        // ä¿®æ­£ï¼šåŠ å…¥ object-top
        monsterImg.className = 'w-full h-full rounded-full object-cover object-top border-4 border-red-500 shadow-xl z-10 relative';
        // æ¸…é™¤ä¹‹å‰çš„å‹•ç•« class
        monsterImg.classList.remove('monster-enrage', 'monster-die');

        // ä¿®æ­£ï¼šåŠ å…¥ object-top
        heroImg.className = 'w-full h-full object-cover object-top rounded-xl border-2 border-white/50 shadow-2xl hero-idle';
        effectOverlay.className = 'absolute inset-0 flex items-center justify-center text-9xl z-50 pointer-events-none opacity-0';

        const giver = drawOrder[currentIndex];
        document.getElementById('drawing-header').classList.remove('hidden'); // æ¢å¾©é¡¯ç¤ºé ‚éƒ¨è³‡è¨Š
        document.getElementById('current-giver').innerText = giver;
        document.getElementById('round-number').innerText = currentIndex + 1;

        // æª¢æŸ¥æ˜¯å¦ç‚ºæœ€å¾Œä¸€å±€ (ç¬¬15å±€)
        const nextBtn = document.getElementById('next-round-btn');
        if (currentIndex === participants.length - 1) {
            nextBtn.innerText = "ğŸ“œ å…¬å¸ƒæˆ°å½¹çµæœ ğŸ“œ";
            nextBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-400');
            nextBtn.classList.add('bg-red-600', 'hover:bg-red-500', 'text-white'); // æ”¹æˆé¡¯çœ¼çš„ç´…è‰²
        } else {
            nextBtn.innerText = "ä¸‹ä¸€ä½ âœ";
            nextBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-400');
            nextBtn.classList.remove('bg-red-600', 'hover:bg-red-500', 'text-white');
        }
    }

    function revealReceiver() {
        // æª¢æŸ¥æ˜¯å¦é¡¯ç¤ºéæ•™å­¸
        const hasShown = localStorage.getItem('xmasInstructionShown');
        
        if (!hasShown) {
            document.getElementById('instruction-modal').classList.remove('hidden');
            return;
        }

        performReveal();
    }

    function closeInstructionModal() {
        localStorage.setItem('xmasInstructionShown', 'true');
        document.getElementById('instruction-modal').classList.add('hidden');
        performReveal();
    }

    function performReveal() {
        const receiver = drawOrder[(currentIndex + 1) % drawOrder.length];
        
        // 1. æ’­æ”¾éŸ³æ•ˆä¸¦è¨­å®šå»¶é²
        let delay = 500; // éœéŸ³æ™‚ç¨å¾®åœé “ä¸€ä¸‹
        if (!userMuted) {
            const giftAudio = document.getElementById('gift-sound');
            giftAudio.currentTime = 0;
            giftAudio.play().catch(e => console.log("éŸ³æ•ˆæ’­æ”¾å¤±æ•—", e));
            delay = 2500; // æœ‰éŸ³æ¨‚æ™‚ï¼Œç­‰å¾… 2.5 ç§’è®“éŸ³æ¨‚æ’­ä¸€æœƒå…’
        }

        // 2. å¢åŠ ç­‰å¾…æ™‚çš„å‹•ç•«å›é¥‹
        const giftBox = document.getElementById('gift-box-area');
        giftBox.classList.add('gift-shake'); // æ”¹ç”¨è‡ªå®šç¾©æ–æ™ƒ

        // 3. å»¶é²é¡¯ç¤ºçµæœ
        setTimeout(() => {
            giftBox.classList.remove('gift-shake');
            giftBox.classList.add('hidden');
            document.getElementById('reveal-area').classList.remove('hidden');
            
            document.getElementById('current-receiver').innerText = receiver;
            
            const imgPath = getHeroImage(receiver);
            document.getElementById('hero-img').src = imgPath;
            document.getElementById('battle-hero-name').innerText = receiver;

            const satisfiedTexts = ["æˆ‘è¶…æ»¿æ„ï¼<br>é–‹å•Ÿè‹±é›„æ”»æ“Š", "æ»¿æ„<br>å®ˆè­·åŸå¸‚"];
            document.getElementById('satisfied-text').innerHTML = satisfiedTexts[Math.floor(Math.random() * satisfiedTexts.length)];
            const dissatisfiedTexts = ["æœ‰é»å¤±æœ›<br>çœ‹çœ‹éº‹é¹¿åæ“Š", "ä¸æ»¿æ„<br>å±æ©Ÿé™è‡¨"];
            document.getElementById('dissatisfied-text').innerHTML = dissatisfiedTexts[Math.floor(Math.random() * dissatisfiedTexts.length)];
        }, delay);
    }

    function handleFeedback(isSatisfied) {
        const giver = drawOrder[currentIndex];
        const receiver = drawOrder[(currentIndex + 1) % drawOrder.length];
        
        let scenario;
        document.getElementById('battle-result-area').classList.add('hidden');
        
        const videoElement = document.getElementById('battle-video');
        videoElement.classList.add('hidden');
        videoElement.pause();
        videoElement.src = ""; // æ¸…ç©ºä¾†æº

        const monsterImg = document.getElementById('monster-img');

        const heroImg = document.getElementById('hero-img');
        const effectOverlay = document.getElementById('effect-overlay');
        const battleText = document.getElementById('battle-text');
        
        document.getElementById('reveal-area').classList.add('hidden');
        document.getElementById('drawing-header').classList.add('hidden'); // éš±è—é ‚éƒ¨è³‡è¨Š (Round/è´ˆç¦®è€…)
        document.getElementById('battle-result-area').classList.remove('hidden');

        // è¨­å®šé€ åŠ«è€…èˆ‡æ¸¡åŠ«è€…è³‡è¨Š
        document.getElementById('result-giver').innerText = giver;
        document.getElementById('result-receiver').innerText = receiver;
        
        // é å…ˆè¨ˆç®—åŠ‡æƒ…çµæœ (Early Calculation)
        if (isSatisfied) {
            // å‹åˆ©
            const specificAttack = heroAttacks[giver];
            if (specificAttack) {
                scenario = { emoji: 'âœ¨', text: specificAttack };
            } else {
                scenario = victoryScenarios[Math.floor(Math.random() * victoryScenarios.length)];
            }
        } else {
             // å¤±æ•—
             const specificDefeat = heroDefeats[giver];
             if (specificDefeat) {
                 scenario = { emoji: 'ğŸ˜¨', text: specificDefeat }; 
             } else {
                 scenario = defeatScenarios[Math.floor(Math.random() * defeatScenarios.length)];
             }
        }

        // ç›´æ¥é¡¯ç¤ºæœ€çµ‚çµæœ (Immediate Display)
        battleText.innerText = scenario.text;
        
        // è¨­å®šåœ–ç‰‡èˆ‡åŸºæœ¬è³‡è¨Š
        // if (!isSatisfied) heroImg.classList.add('shake-light'); // ç§»é™¤æ–æ™ƒï¼Œå› ç‚ºé¦¬ä¸Šæ’­å½±ç‰‡ä¸”éš±è—åœ–ç‰‡äº†

        // å–å¾—åŸºç¤æª”å (å»æ‰ .jpg å¾Œç¶´)
        const baseImage = getHeroImage(giver);
        const baseName = baseImage.replace('.jpg', '');
        
        const videoName = isSatisfied ? `${baseName}_win.mp4` : `${baseName}_lose.mp4`;

        // é‡ç½®ä¸¦æ’­æ”¾å½±ç‰‡
        monsterImg.classList.add('hidden'); 
        document.getElementById('hero-display-area').classList.add('hidden'); // éš±è—åº•éƒ¨è‹±é›„åœ–
        
        // æš«åœèƒŒæ™¯éŸ³æ¨‚
        bgm.pause();
        updateMusicBtn();
        
        videoElement.classList.remove('hidden');
        videoElement.src = videoName;
        videoElement.play().catch(e => {
            console.log("å½±ç‰‡æ’­æ”¾å¤±æ•—", e);
             if (!userMuted && bgm.src.includes('war.mp3')) bgm.play();
        });

        // å»¶é²è™•ç†è³‡æ–™å„²å­˜ (ä¿ç•™å»¶é²æ˜¯ç‚ºäº†é¿å…ç¬é–“ç¨å¾®å¡é “ï¼Œé›–ç„¶JSæ˜¯å–®ç·šç¨‹ä½†ç¿’æ…£ä¸Šåˆ†é–‹ä¹Ÿå¥½)
        setTimeout(() => {
            // è™•ç†åœ–ç‰‡å‹•ç•«ç‹€æ…‹ (é›–ç„¶ç›®å‰éš±è—ï¼Œä½†ç‚ºäº†ç‹€æ…‹æ­£ç¢ºæ€§é‚„æ˜¯åŸ·è¡Œ)
            heroImg.classList.remove('hero-idle', 'shake-light');
            if (!isSatisfied) {
                const deaths = ['hero-fly-away', 'hero-dead', 'hero-flatten', 'hero-spiral', 'hero-drop'];
                const randomDeath = deaths[Math.floor(Math.random() * deaths.length)];
                heroImg.classList.add(randomDeath);
                document.getElementById('hero-damage-overlay').classList.add('anim-damage');
            }

            battleHistory.push({ giver, receiver, isSatisfied, scenario });
            localStorage.setItem('xmasState', JSON.stringify({ step: 'drawing', battleHistory: battleHistory }));

        }, 100); // ç¸®çŸ­å»¶é²æ™‚é–“

    }

    function nextRound() {
        if (currentIndex < drawOrder.length - 1) {
            currentIndex++;
            enterDraw();
        } else {
            // å·²çµæŸï¼Œé¡¯ç¤ºå¤§çµå±€
            showGrandFinale();
        }
    }
    
    function showGrandFinale() {
        document.getElementById('view-story').classList.add('hidden');
        document.getElementById('view-drawing').classList.add('hidden'); // ä¿®æ­£ï¼šéš±è—åŸæœ¬çš„æŠ½ç±¤/æˆ°é¬¥ç•«é¢
        document.getElementById('view-grand-finale').classList.remove('hidden');
        
        // ç¢ºä¿åœ¨ç•«é¢åˆ‡æ›å¾Œæ‰æ²å‹•
        setTimeout(() => {
            window.scrollTo({ top: 0, behavior: 'auto' });
        }, 10);
        
        // æš«åœèƒŒæ™¯éŸ³æ¨‚ï¼Œå°ˆå¿ƒçœ‹çµå±€
        bgm.pause();
        updateMusicBtn();
        
        let heroWins = 0;
        let monsterWins = 0;
        
        battleHistory.forEach(record => {
            if (record.isSatisfied) heroWins++;
            else monsterWins++;
        });
        
        document.getElementById('final-score-hero').innerText = heroWins;
        document.getElementById('final-score-monster').innerText = monsterWins;
        
        const videoElement = document.getElementById('final-video');
        let finalVideoName = '';
        
        if (heroWins > monsterWins) finalVideoName = 'victory.mp4';
        else if (monsterWins > heroWins) finalVideoName = 'loss.mp4';
        else finalVideoName = 'peace.mp4';
        
        videoElement.src = finalVideoName;
        videoElement.play().catch(e => console.log("çµå±€å½±ç‰‡æ’­æ”¾å¤±æ•—", e));
        
        // å„²å­˜ç‹€æ…‹ï¼Œç¢ºä¿é‡æ•´å¾Œèƒ½å›ä¾†
        localStorage.setItem('xmasState', JSON.stringify({ step: 'finale', battleHistory: battleHistory }));

        // è§¸ç™¼ç‰¹æ•ˆ (å‹åˆ©ï¼šå½©å¸¶ / å¤±æ•—ï¼šè½è‘‰)
        if (heroWins > monsterWins) {
            startConfetti();
        } else if (monsterWins > heroWins) {
            startFallingLeaves();
        }
    }

    function showResultsList() {
        document.getElementById('view-grand-finale').classList.add('hidden');
        showView('view-result');
        renderResults(battleHistory);
        localStorage.setItem('xmasState', JSON.stringify({ step: 'result', battleHistory: battleHistory }));

        // ç¢ºä¿åœ¨ç•«é¢åˆ‡æ›å¾Œæ‰æ²å‹•
        setTimeout(() => {
            window.scrollTo({ top: 0, behavior: 'auto' });
        }, 10);
    }

    function renderResults(history) {
        const container = document.getElementById('final-list');
        container.innerHTML = '';
        history.forEach((battle) => {
            const div = document.createElement('div');
            div.className = `p-4 border-b border-gray-200 ${battle.isSatisfied ? 'bg-green-50' : 'bg-red-50'}`;
            const resultText = battle.isSatisfied ? 'âœ… æˆåŠŸæ“Šé€€' : `âŒ ${battle.giver} ä¸å¹¸è½æ•—`;
            
            div.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <div class="font-bold text-lg">
                        <span class="text-gray-600">${battle.giver}</span>
                        <span class="mx-2 text-gray-400">âœ</span>
                        <span class="text-blue-600">${battle.receiver}</span>
                    </div>
                    <div class="text-sm font-bold ${battle.isSatisfied ? 'text-green-600' : 'text-red-600'}">${resultText}</div>
                </div>
                <div class="text-sm text-gray-600 italic">
                    ${battle.scenario.emoji} ${battle.scenario.text}
                </div>
            `;
            container.appendChild(div);
        });
    }

    function resetData() {
        document.getElementById('reset-modal').classList.remove('hidden');
    }

    function closeResetModal() {
        document.getElementById('reset-modal').classList.add('hidden');
    }

    function confirmReset() {
        localStorage.removeItem('xmasParticipants');
        localStorage.removeItem('xmasGender');
        localStorage.removeItem('xmasCouple');
        localStorage.removeItem('xmasState');
        localStorage.removeItem('xmasInstructionShown'); // æ¸…é™¤æ•™å­¸ç´€éŒ„
        location.reload();
    }



    function showView(id) {
        ['view-setup', 'view-story', 'view-drawing', 'view-result'].forEach(v => {
            document.getElementById(v).classList.add('hidden');
        });
        document.getElementById(id).classList.remove('hidden');
    }

    // --- ç°¡æ˜“å½©å¸¶ç‰¹æ•ˆ (Confetti) ---
    function startConfetti() {
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        canvas.classList.remove('hidden');

        const particles = [];
        const colors = ['#f43f5e', '#fbbf24', '#34d399', '#60a5fa', '#a78bfa', '#ffffff'];

        for (let i = 0; i < 150; i++) {
            particles.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height - canvas.height,
                w: Math.random() * 10 + 5,
                h: Math.random() * 5 + 5,
                color: colors[Math.floor(Math.random() * colors.length)],
                speed: Math.random() * 3 + 2,
                drift: Math.random() * 2 - 1,
                rotation: Math.random() * 360
            });
        }

        let animationId;
        function loop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => {
                p.y += p.speed;
                p.x += p.drift;
                p.rotation += 2;
                
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.rotation * Math.PI / 180);
                ctx.fillStyle = p.color;
                ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
                ctx.restore();

                if (p.y > canvas.height) {
                    p.y = -20;
                    p.x = Math.random() * canvas.width;
                }
            });
            animationId = requestAnimationFrame(loop);
        }
        loop();

        // 8ç§’å¾Œåœæ­¢
        setTimeout(() => {
            cancelAnimationFrame(animationId);
            canvas.classList.add('hidden');
        }, 8000);
    }

    // --- è½è‘‰é£„é›¶ (Falling Leaves) ---
    function startFallingLeaves() {
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        canvas.classList.remove('hidden');
        
        // åŠ å…¥ç§‹æ—¥é®ç½©
        const app = document.getElementById('app');
        const overlay = document.createElement('div');
        overlay.className = 'autumn-overlay fade-in';
        app.appendChild(overlay);

        const particles = [];
        const colors = ['#d97706', '#b45309', '#92400e', '#f59e0b', '#78350f']; // æ©˜ã€è¤ã€æ·±é»ƒ

        for (let i = 0; i < 60; i++) { // è‘‰å­ä¸ç”¨å¤ªå¤š
            particles.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                w: Math.random() * 10 + 10,
                h: Math.random() * 8 + 5,
                color: colors[Math.floor(Math.random() * colors.length)],
                speed: Math.random() * 2 + 1, // é£„æ…¢ä¸€é»
                drift: Math.random() * 2 - 1,
                rotation: Math.random() * 360,
                spinSpeed: Math.random() * 4 - 2 // æ—‹è½‰é€Ÿåº¦
            });
        }

        let animationId;
        function loop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            particles.forEach(p => {
                p.y += p.speed;
                p.x += Math.sin(p.y / 100) * 2; // å·¦å³æ–æ“º (SINE WAVE)
                p.rotation += p.spinSpeed;
                
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.rotation * Math.PI / 180);
                
                // ç•«è‘‰å­å½¢ç‹€ (ç°¡å–®æ©¢åœ“)
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.ellipse(0, 0, p.w / 2, p.h / 2, 0, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.restore();

                if (p.y > canvas.height) {
                    p.y = -20;
                    p.x = Math.random() * canvas.width;
                }
            });
            animationId = requestAnimationFrame(loop);
        }
        loop();

        // 8ç§’å¾Œåœæ­¢
        setTimeout(() => {
            cancelAnimationFrame(animationId);
            canvas.classList.add('hidden');
            overlay.classList.remove('fade-in');
            overlay.classList.add('fade-out'); // ç°¡å–®æ·¡å‡º logic æˆ–ç›´æ¥ç§»é™¤
            setTimeout(() => overlay.remove(), 1000);
        }, 8000);
    }
</script>

</body>
</html>
